'use client';

import {
  Stack,
  Title,
  Text,
  Card,
  Group,
  Button,
  Badge,
  Table,
  ScrollArea,
  ActionIcon,
  Switch,
  TextInput,
  Select,
  NumberInput,
  SimpleGrid,
  ThemeIcon,
  Progress,
  Tooltip,
  Paper,
  LoadingOverlay,
  Alert,
  Tabs,
  Code,
  Grid,
} from '@mantine/core';
import {
  IconMicrophone,
  IconSettings,
  IconPlus,
  IconEdit,
  IconTrash,
  IconPlayerPlay,
  IconCircleCheck,
  IconAlertCircle,
  IconVolume,
  IconVolumeOff,
  IconRefresh,
  IconDownload,
  IconTestPipe,
  IconMicrophoneOff,
  IconBrandOpenai,
  IconBrain,
  IconApi,
  IconClock,
} from '@tabler/icons-react';
import { useState, useEffect } from 'react';
import { notifications } from '@mantine/notifications';
import { formatters } from '@/lib/utils/formatters';

interface AudioProvider {
  id: string;
  name: string;
  type: 'openai' | 'azure' | 'elevenlabs' | 'google' | 'aws' | 'custom';
  enabled: boolean;
  models: AudioModel[];
  config: AudioProviderConfig;
  status: 'active' | 'inactive' | 'error';
  lastChecked?: string;
  totalRequests: number;
  totalMinutes: number;
  avgLatency: number;
  errorRate: number;
}

interface AudioModel {
  id: string;
  name: string;
  type: 'transcription' | 'tts' | 'both';
  languages: string[];
  maxDuration?: number;
  costPerMinute: number;
  enabled: boolean;
}

interface AudioProviderConfig {
  apiKey?: string;
  endpoint?: string;
  region?: string;
  voice?: string;
  sampleRate?: number;
  format?: string;
  maxConcurrency?: number;
  timeout?: number;
}

interface AudioStats {
  providerId: string;
  transcriptionRequests: number;
  ttsRequests: number;
  totalMinutes: number;
  avgProcessingTime: number;
  successRate: number;
  cost: number;
}

export default function AudioProvidersPage() {
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [providers, setProviders] = useState<AudioProvider[]>([]);
  const [stats, setStats] = useState<Record<string, AudioStats>>({});
  const [activeTab, setActiveTab] = useState<string | null>('providers');
  const [selectedProvider, setSelectedProvider] = useState<string | null>(null);
  const [isEditing, setIsEditing] = useState(false);

  useEffect(() => {
    fetchProviders();
  }, []);

  const fetchProviders = async () => {
    try {
      // TODO: DIRECT API CALLS ARE FORBIDDEN - USE SDK INSTEAD
      throw new Error('Direct API calls are forbidden - SDK not available');
          enabled: true,
          models: [
            {
              id: 'whisper-1',
              name: 'Whisper v1',
              type: 'transcription',
              languages: ['en', 'es', 'fr', 'de', 'it', 'pt', 'nl', 'pl', 'ru', 'zh', 'ja', 'ko'],
              maxDuration: 180,
              costPerMinute: 0.006,
              enabled: true,
            },
            {
              id: 'tts-1',
              name: 'TTS v1',
              type: 'tts',
              languages: ['en', 'es', 'fr', 'de', 'it', 'pt', 'nl', 'pl', 'ru', 'zh', 'ja', 'ko'],
              costPerMinute: 0.015,
              enabled: true,
            },
            {
              id: 'tts-1-hd',
              name: 'TTS v1 HD',
              type: 'tts',
              languages: ['en', 'es', 'fr', 'de', 'it', 'pt', 'nl', 'pl', 'ru', 'zh', 'ja', 'ko'],
              costPerMinute: 0.030,
              enabled: true,
            },
          ],
          config: {
            apiKey: 'sk-••••••••',
            endpoint: 'https://api.openai.com/v1',
            format: 'mp3',
            voice: 'alloy',
            sampleRate: 24000,
            maxConcurrency: 5,
            timeout: 300000,
          },
          status: 'active',
          lastChecked: '2024-01-10T12:30:00Z',
          totalRequests: 15234,
          totalMinutes: 8432,
          avgLatency: 450,
          errorRate: 0.2,
        },
        {
          id: 'elevenlabs',
          name: 'ElevenLabs',
          type: 'elevenlabs',
          enabled: true,
          models: [
            {
              id: 'eleven-monolingual-v1',
              name: 'Monolingual v1',
              type: 'tts',
              languages: ['en'],
              costPerMinute: 0.30,
              enabled: true,
            },
            {
              id: 'eleven-multilingual-v2',
              name: 'Multilingual v2',
              type: 'tts',
              languages: ['en', 'es', 'fr', 'de', 'it', 'pt', 'pl', 'hi'],
              costPerMinute: 0.48,
              enabled: true,
            },
          ],
          config: {
            apiKey: 'xi-••••••••',
            endpoint: 'https://api.elevenlabs.io/v1',
            voice: 'Rachel',
            sampleRate: 44100,
            maxConcurrency: 3,
            timeout: 120000,
          },
          status: 'active',
          lastChecked: '2024-01-10T12:25:00Z',
          totalRequests: 5678,
          totalMinutes: 2345,
          avgLatency: 380,
          errorRate: 0.5,
        },
        {
          id: 'azure-speech',
          name: 'Azure Speech Services',
          type: 'azure',
          enabled: true,
          models: [
            {
              id: 'azure-speech-to-text',
              name: 'Speech to Text',
              type: 'transcription',
              languages: ['en', 'es', 'fr', 'de', 'it', 'pt', 'nl', 'pl', 'ru', 'zh', 'ja', 'ko', 'ar'],
              maxDuration: 300,
              costPerMinute: 0.016,
              enabled: true,
            },
            {
              id: 'azure-neural-tts',
              name: 'Neural TTS',
              type: 'tts',
              languages: ['en', 'es', 'fr', 'de', 'it', 'pt', 'nl', 'pl', 'ru', 'zh', 'ja', 'ko'],
              costPerMinute: 0.016,
              enabled: true,
            },
          ],
          config: {
            apiKey: '••••••••',
            endpoint: 'https://westus.api.cognitive.microsoft.com',
            region: 'westus',
            format: 'audio-16khz-128kbitrate-mono-mp3',
            maxConcurrency: 10,
            timeout: 300000,
          },
          status: 'active',
          lastChecked: '2024-01-10T12:28:00Z',
          totalRequests: 8934,
          totalMinutes: 4567,
          avgLatency: 320,
          errorRate: 0.3,
        },
        {
          id: 'google-speech',
          name: 'Google Cloud Speech',
          type: 'google',
          enabled: false,
          models: [
            {
              id: 'google-standard',
              name: 'Standard',
              type: 'both',
              languages: ['en', 'es', 'fr', 'de', 'it', 'pt', 'nl', 'ru', 'zh', 'ja', 'ko', 'ar', 'hi'],
              maxDuration: 480,
              costPerMinute: 0.024,
              enabled: true,
            },
          ],
          config: {
            apiKey: '••••••••',
            endpoint: 'https://speech.googleapis.com/v1',
            maxConcurrency: 5,
            timeout: 300000,
          },
          status: 'inactive',
          lastChecked: '2024-01-09T18:30:00Z',
          totalRequests: 2345,
          totalMinutes: 1234,
          avgLatency: 410,
          errorRate: 0.8,
        },
      ];

      const mockStats: Record<string, AudioStats> = {
        'openai-whisper': {
          providerId: 'openai-whisper',
          transcriptionRequests: 12456,
          ttsRequests: 2778,
          totalMinutes: 8432,
          avgProcessingTime: 450,
          successRate: 99.8,
          cost: 126.48,
        },
        'elevenlabs': {
          providerId: 'elevenlabs',
          transcriptionRequests: 0,
          ttsRequests: 5678,
          totalMinutes: 2345,
          avgProcessingTime: 380,
          successRate: 99.5,
          cost: 845.40,
        },
        'azure-speech': {
          providerId: 'azure-speech',
          transcriptionRequests: 4567,
          ttsRequests: 4367,
          totalMinutes: 4567,
          avgProcessingTime: 320,
          successRate: 99.7,
          cost: 73.07,
        },
        'google-speech': {
          providerId: 'google-speech',
          transcriptionRequests: 1234,
          ttsRequests: 1111,
          totalMinutes: 1234,
          avgProcessingTime: 410,
          successRate: 99.2,
          cost: 29.62,
        },
      };

    } catch (error) {
      console.error('Error fetching audio providers:', error);
      notifications.show({
        title: 'Error',
        message: 'Failed to load audio providers',
        color: 'red',
      });
    } finally {
      setIsLoading(false);
    }
  };

  const handleRefresh = async () => {
    setIsRefreshing(true);
    await fetchProviders();
    setIsRefreshing(false);
    notifications.show({
      title: 'Refreshed',
      message: 'Audio provider data updated',
      color: 'green',
    });
  };

  const handleTestProvider = async (providerId: string) => {
    try {
      // TODO: DIRECT API CALLS ARE FORBIDDEN - USE SDK INSTEAD
      // const response = await fetch(`/api/admin/audio-configuration/${providerId}/test`, {
      //   method: 'POST',
      //   headers: {
      //     'X-Admin-Auth-Key': localStorage.getItem('adminAuthKey') || '',
      //   },
      // });
      //
      // if (!response.ok) {
      //   throw new Error('Test failed');
      // }
      
      // Functionality broken - SDK not available
      throw new Error('Direct API calls are forbidden - SDK not available');

      notifications.show({
        title: 'Test Successful',
        message: 'Audio provider is working correctly',
        color: 'green',
      });
    } catch (error) {
      notifications.show({
        title: 'Test Failed',
        message: 'Failed to connect to audio provider',
        color: 'red',
      });
    }
  };

  const handleToggleProvider = async (providerId: string, enabled: boolean) => {
    try {
      // TODO: DIRECT API CALLS ARE FORBIDDEN - USE SDK INSTEAD
      // const response = await fetch(`/api/admin/audio-configuration/${providerId}`, {
      //   method: 'PUT',
      //   headers: {
      //     'Content-Type': 'application/json',
          'X-Admin-Auth-Key': localStorage.getItem('adminAuthKey') || '',
        },
        body: JSON.stringify({ enabled }),
      });

      if (!response.ok) {
        throw new Error('Failed to update provider');
      }

      await fetchProviders();
      notifications.show({
        title: 'Updated',
        message: `Provider ${enabled ? 'enabled' : 'disabled'} successfully`,
        color: 'green',
      });
    } catch (error) {
      notifications.show({
        title: 'Error',
        message: 'Failed to update provider',
        color: 'red',
      });
    }
  };

  const getProviderIcon = (type: string) => {
    switch (type) {
      case 'openai': return <IconBrandOpenai size={20} />;
      case 'elevenlabs': return <IconVolume size={20} />;
      case 'azure': return <IconBrain size={20} />;
      case 'google': return <IconApi size={20} />;
      default: return <IconMicrophone size={20} />;
    }
  };

  const totalStats = {
    totalRequests: Object.values(stats).reduce((acc, s) => acc + s.transcriptionRequests + s.ttsRequests, 0),
    totalMinutes: Object.values(stats).reduce((acc, s) => acc + s.totalMinutes, 0),
    totalCost: Object.values(stats).reduce((acc, s) => acc + s.cost, 0),
    avgSuccessRate: Object.values(stats).reduce((acc, s) => acc + s.successRate, 0) / Object.values(stats).length || 0,
  };

  if (isLoading) {
    return (
      <Stack>
        <Card shadow="sm" p="md" radius="md" pos="relative" mih={200}>
          <LoadingOverlay visible={true} />
        </Card>
      </Stack>
    );
  }

  return (
    <Stack gap="xl">
      <Card shadow="sm" p="md" radius="md">
        <Group justify="space-between" align="center">
          <div>
            <Title order={2}>Audio Providers</Title>
            <Text size="sm" c="dimmed" mt={4}>
              Configure speech-to-text and text-to-speech providers
            </Text>
          </div>
          <Group>
            <Button
              variant="light"
              leftSection={<IconRefresh size={16} />}
              onClick={handleRefresh}
              loading={isRefreshing}
            >
              Refresh
            </Button>
            <Button
              variant="filled"
              leftSection={<IconPlus size={16} />}
              onClick={() => {
                setSelectedProvider(null);
                setIsEditing(true);
              }}
            >
              Add Provider
            </Button>
          </Group>
        </Group>
      </Card>

      <SimpleGrid cols={{ base: 1, sm: 2, lg: 4 }} spacing="md">
        <Card padding="lg" radius="md" withBorder>
          <Group justify="space-between">
            <div>
              <Text size="sm" c="dimmed" fw={600} tt="uppercase">
                Total Requests
              </Text>
              <Text size="xl" fw={700} mt={4}>
                {totalStats.totalRequests.toLocaleString()}
              </Text>
              <Text size="xs" c="dimmed" mt={4}>
                Last 30 days
              </Text>
            </div>
            <ThemeIcon color="blue" variant="light" size={48} radius="md">
              <IconMicrophone size={24} />
            </ThemeIcon>
          </Group>
        </Card>

        <Card padding="lg" radius="md" withBorder>
          <Group justify="space-between">
            <div>
              <Text size="sm" c="dimmed" fw={600} tt="uppercase">
                Audio Processed
              </Text>
              <Text size="xl" fw={700} mt={4}>
                {formatters.duration(totalStats.totalMinutes * 60000)}
              </Text>
              <Text size="xs" c="dimmed" mt={4}>
                {totalStats.totalMinutes.toLocaleString()} minutes
              </Text>
            </div>
            <ThemeIcon color="green" variant="light" size={48} radius="md">
              <IconClock size={24} />
            </ThemeIcon>
          </Group>
        </Card>

        <Card padding="lg" radius="md" withBorder>
          <Group justify="space-between">
            <div>
              <Text size="sm" c="dimmed" fw={600} tt="uppercase">
                Total Cost
              </Text>
              <Text size="xl" fw={700} mt={4}>
                ${totalStats.totalCost.toFixed(2)}
              </Text>
              <Text size="xs" c="dimmed" mt={4}>
                This month
              </Text>
            </div>
            <ThemeIcon color="orange" variant="light" size={48} radius="md">
              <IconPlayerPlay size={24} />
            </ThemeIcon>
          </Group>
        </Card>

        <Card padding="lg" radius="md" withBorder>
          <Group justify="space-between">
            <div>
              <Text size="sm" c="dimmed" fw={600} tt="uppercase">
                Success Rate
              </Text>
              <Text size="xl" fw={700} mt={4}>
                {totalStats.avgSuccessRate.toFixed(1)}%
              </Text>
              <Text size="xs" c="dimmed" mt={4}>
                Across all providers
              </Text>
            </div>
            <ThemeIcon color="teal" variant="light" size={48} radius="md">
              <IconCircleCheck size={24} />
            </ThemeIcon>
          </Group>
        </Card>
      </SimpleGrid>

      <Tabs value={activeTab} onChange={setActiveTab}>
        <Tabs.List>
          <Tabs.Tab value="providers" leftSection={<IconMicrophone size={16} />}>
            Providers
          </Tabs.Tab>
          <Tabs.Tab value="models" leftSection={<IconBrain size={16} />}>
            Models
          </Tabs.Tab>
          <Tabs.Tab value="usage" leftSection={<IconPlayerPlay size={16} />}>
            Usage Statistics
          </Tabs.Tab>
        </Tabs.List>

        <Tabs.Panel value="providers" pt="md">
          <Card shadow="sm" p="md" radius="md" withBorder>
            <ScrollArea>
              <Table>
                <Table.Thead>
                  <Table.Tr>
                    <Table.Th>Provider</Table.Th>
                    <Table.Th>Models</Table.Th>
                    <Table.Th>Requests</Table.Th>
                    <Table.Th>Cost</Table.Th>
                    <Table.Th>Status</Table.Th>
                    <Table.Th>Actions</Table.Th>
                  </Table.Tr>
                </Table.Thead>
                <Table.Tbody>
                  {providers.map((provider) => {
                    const providerStats = stats[provider.id];
                    return (
                      <Table.Tr key={provider.id}>
                        <Table.Td>
                          <Group gap="xs">
                            {getProviderIcon(provider.type)}
                            <div>
                              <Text fw={500}>{provider.name}</Text>
                              <Text size="xs" c="dimmed">
                                {provider.config.endpoint?.replace('https://', '')}
                              </Text>
                            </div>
                          </Group>
                        </Table.Td>
                        <Table.Td>
                          <Group gap="xs">
                            {provider.models.filter(m => m.enabled).length} / {provider.models.length} active
                          </Group>
                        </Table.Td>
                        <Table.Td>
                          {providerStats ? providerStats.transcriptionRequests + providerStats.ttsRequests : 0}
                        </Table.Td>
                        <Table.Td>
                          ${providerStats?.cost.toFixed(2) || '0.00'}
                        </Table.Td>
                        <Table.Td>
                          <Badge
                            leftSection={provider.status === 'active' ? <IconCircleCheck size={12} /> : <IconAlertCircle size={12} />}
                            color={provider.status === 'active' ? 'green' : provider.status === 'error' ? 'red' : 'gray'}
                            variant="light"
                          >
                            {provider.status}
                          </Badge>
                        </Table.Td>
                        <Table.Td>
                          <Group gap="xs">
                            <Switch
                              checked={provider.enabled}
                              onChange={(e) => handleToggleProvider(provider.id, e.currentTarget.checked)}
                              size="sm"
                            />
                            <Tooltip label="Test connection">
                              <ActionIcon
                                variant="light"
                                onClick={() => handleTestProvider(provider.id)}
                                disabled={!provider.enabled}
                              >
                                <IconTestPipe size={16} />
                              </ActionIcon>
                            </Tooltip>
                            <Tooltip label="Configure">
                              <ActionIcon
                                variant="light"
                                onClick={() => {
                                  setSelectedProvider(provider.id);
                                  setIsEditing(true);
                                }}
                              >
                                <IconSettings size={16} />
                              </ActionIcon>
                            </Tooltip>
                          </Group>
                        </Table.Td>
                      </Table.Tr>
                    );
                  })}
                </Table.Tbody>
              </Table>
            </ScrollArea>
          </Card>
        </Tabs.Panel>

        <Tabs.Panel value="models" pt="md">
          <Card shadow="sm" p="md" radius="md" withBorder>
            <ScrollArea>
              <Table>
                <Table.Thead>
                  <Table.Tr>
                    <Table.Th>Model</Table.Th>
                    <Table.Th>Provider</Table.Th>
                    <Table.Th>Type</Table.Th>
                    <Table.Th>Languages</Table.Th>
                    <Table.Th>Cost/Min</Table.Th>
                    <Table.Th>Status</Table.Th>
                  </Table.Tr>
                </Table.Thead>
                <Table.Tbody>
                  {providers.flatMap(provider => 
                    provider.models.map(model => ({
                      ...model,
                      providerName: provider.name,
                      providerEnabled: provider.enabled,
                    }))
                  ).map((model) => (
                    <Table.Tr key={`${model.providerName}-${model.id}`}>
                      <Table.Td>
                        <Text fw={500}>{model.name}</Text>
                      </Table.Td>
                      <Table.Td>{model.providerName}</Table.Td>
                      <Table.Td>
                        <Badge
                          color={model.type === 'transcription' ? 'blue' : model.type === 'tts' ? 'green' : 'orange'}
                          variant="light"
                        >
                          {model.type === 'transcription' ? 'STT' : model.type === 'tts' ? 'TTS' : 'Both'}
                        </Badge>
                      </Table.Td>
                      <Table.Td>
                        <Text size="sm">{model.languages.slice(0, 5).join(', ')}{model.languages.length > 5 ? ` +${model.languages.length - 5}` : ''}</Text>
                      </Table.Td>
                      <Table.Td>
                        ${model.costPerMinute.toFixed(3)}
                      </Table.Td>
                      <Table.Td>
                        <Badge
                          color={model.enabled && model.providerEnabled ? 'green' : 'gray'}
                          variant="light"
                        >
                          {model.enabled && model.providerEnabled ? 'Active' : 'Inactive'}
                        </Badge>
                      </Table.Td>
                    </Table.Tr>
                  ))}
                </Table.Tbody>
              </Table>
            </ScrollArea>
          </Card>
        </Tabs.Panel>

        <Tabs.Panel value="usage" pt="md">
          <Grid>
            <Grid.Col span={{ base: 12, md: 6 }}>
              <Card shadow="sm" p="md" radius="md" withBorder>
                <Title order={4} mb="md">Usage by Provider</Title>
                <Stack gap="sm">
                  {providers.map((provider) => {
                    const providerStats = stats[provider.id];
                    if (!providerStats) return null;
                    
                    const percentage = (providerStats.totalMinutes / totalStats.totalMinutes) * 100;
                    
                    return (
                      <Paper key={provider.id} p="sm" withBorder>
                        <Group justify="space-between" mb="xs">
                          <Group gap="xs">
                            {getProviderIcon(provider.type)}
                            <Text fw={500}>{provider.name}</Text>
                          </Group>
                          <Text fw={600}>
                            {formatters.duration(providerStats.totalMinutes * 60000)}
                          </Text>
                        </Group>
                        <Progress
                          value={percentage}
                          color="blue"
                          size="sm"
                          radius="md"
                        />
                        <Group justify="space-between" mt="xs">
                          <Text size="xs" c="dimmed">
                            {providerStats.transcriptionRequests + providerStats.ttsRequests} requests
                          </Text>
                          <Text size="xs" c="dimmed">
                            ${providerStats.cost.toFixed(2)}
                          </Text>
                        </Group>
                      </Paper>
                    );
                  })}
                </Stack>
              </Card>
            </Grid.Col>

            <Grid.Col span={{ base: 12, md: 6 }}>
              <Card shadow="sm" p="md" radius="md" withBorder>
                <Title order={4} mb="md">Request Types</Title>
                <Stack gap="md">
                  <Paper p="md" withBorder>
                    <Group justify="space-between" mb="xs">
                      <Text fw={500}>Speech-to-Text</Text>
                      <Text fw={600}>
                        {Object.values(stats).reduce((acc, s) => acc + s.transcriptionRequests, 0).toLocaleString()}
                      </Text>
                    </Group>
                    <Progress
                      value={70}
                      color="blue"
                      size="lg"
                      radius="md"
                    />
                  </Paper>
                  <Paper p="md" withBorder>
                    <Group justify="space-between" mb="xs">
                      <Text fw={500}>Text-to-Speech</Text>
                      <Text fw={600}>
                        {Object.values(stats).reduce((acc, s) => acc + s.ttsRequests, 0).toLocaleString()}
                      </Text>
                    </Group>
                    <Progress
                      value={30}
                      color="green"
                      size="lg"
                      radius="md"
                    />
                  </Paper>
                </Stack>
              </Card>
            </Grid.Col>
          </Grid>
        </Tabs.Panel>
      </Tabs>

      <LoadingOverlay visible={isRefreshing} />
    </Stack>
  );
}