@using ConduitLLM.Configuration.DTOs.VirtualKey
@using ConduitLLM.WebUI.Data
@using ConduitLLM.WebUI.Services
@using Microsoft.EntityFrameworkCore
@using System.Globalization
@inject IDbContextFactory<ConduitLLM.Configuration.ConfigurationDbContext> ConfigDbContextFactory
@inject ILogger<VirtualKeyUsageDetails> Logger

<MudCard Elevation="2" Class="mb-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Key Usage Details</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                         Color="Color.Default" 
                         Size="Size.Small"
                         OnClick="RefreshData" 
                         aria-label="Refresh" />
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @if (isLoading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (errorMessage != null)
        {
            <MudAlert Severity="Severity.Error" Class="mb-3">@errorMessage</MudAlert>
        }
        else if (keyId == 0)
        {
            <MudAlert Severity="Severity.Info" Class="mb-3">Please select a key to view usage details.</MudAlert>
        }
        else if (usageData == null || !usageData.Any())
        {
            <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info" Class="mb-3">
                No usage data available for this key.
            </MudAlert>
        }
        else
        {
            <MudText Typo="Typo.subtitle1" Class="mb-3">Usage Over Time</MudText>
            <div style="position: relative; height:200px; width:100%" class="mb-4">
                <canvas id="usageChart"></canvas>
            </div>

            <MudGrid Spacing="2" Class="mb-4">
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="0" Class="pa-4 d-flex flex-column align-center" Style="background-color: var(--mud-palette-background-grey)">
                        <MudText Typo="Typo.h5">@totalRequests</MudText>
                        <MudText Typo="Typo.caption">Total Requests</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="0" Class="pa-4 d-flex flex-column align-center" Style="background-color: var(--mud-palette-background-grey)">
                        <MudText Typo="Typo.h5">$@totalCost.ToString("F2")</MudText>
                        <MudText Typo="Typo.caption">Total Cost</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="0" Class="pa-4 d-flex flex-column align-center" Style="background-color: var(--mud-palette-background-grey)">
                        <MudText Typo="Typo.h5">@avgResponseTime.ToString("F0")ms</MudText>
                        <MudText Typo="Typo.caption">Avg. Response Time</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <MudText Typo="Typo.subtitle1" Class="mb-3">Recent Activity</MudText>
            <MudTable Items="@usageData.Take(10)" Hover="true" Dense="true" Class="mb-2">
                <HeaderContent>
                    <MudTh>Date</MudTh>
                    <MudTh>Model</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Tokens</MudTh>
                    <MudTh>Cost</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Date">@context.Timestamp.ToLocalTime().ToString("g")</MudTd>
                    <MudTd DataLabel="Model">@context.ModelName</MudTd>
                    <MudTd DataLabel="Type">@context.RequestType</MudTd>
                    <MudTd DataLabel="Tokens">@context.InputTokens + @context.OutputTokens</MudTd>
                    <MudTd DataLabel="Cost">$@context.Cost.ToString("F4")</MudTd>
                </RowTemplate>
            </MudTable>
            
            @if (usageData.Count > 10)
            {
                <div class="d-flex justify-center mt-3">
                    <MudButton 
                        Variant="Variant.Outlined" 
                        Color="Color.Primary" 
                        Size="Size.Small" 
                        OnClick="ShowAllActivity"
                        StartIcon="@Icons.Material.Filled.List">
                        View All (@usageData.Count) Requests
                    </MudButton>
                </div>
            }
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public int KeyId { get; set; }
    
    private bool isLoading = false;
    private string? errorMessage;
    private List<RequestLogViewModel>? usageData;
    private int totalRequests = 0;
    private decimal totalCost = 0;
    private double avgResponseTime = 0;
    
    private int keyId = 0;
    
    protected override async Task OnParametersSetAsync()
    {
        if (KeyId != keyId)
        {
            keyId = KeyId;
            if (keyId > 0)
            {
                await LoadDataAsync();
            }
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (usageData != null && usageData.Any())
        {
            await RenderChartAsync();
        }
    }
    
    private async Task LoadDataAsync()
    {
        isLoading = true;
        errorMessage = null;
        
        try
        {
            using var context = await ConfigDbContextFactory.CreateDbContextAsync(); 
            
            var logs = await context.RequestLogs
                .Where(r => r.VirtualKeyId == keyId)
                .OrderByDescending(r => r.Timestamp)
                .Take(100) // Limit to recent requests
                .ToListAsync();
                
            usageData = logs.Select(log => new RequestLogViewModel
            {
                Id = log.Id,
                VirtualKeyId = log.VirtualKeyId,
                ModelName = log.ModelName,
                RequestType = log.RequestType,
                InputTokens = log.InputTokens,
                OutputTokens = log.OutputTokens,
                Cost = log.Cost,
                ResponseTimeMs = log.ResponseTimeMs,
                Timestamp = log.Timestamp,
                UserId = log.UserId
            }).ToList();
            
            totalRequests = usageData.Count;
            totalCost = usageData.Sum(d => d.Cost);
            avgResponseTime = usageData.Any() ? usageData.Average(d => d.ResponseTimeMs) : 0;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading usage data: {ex.Message}";
            Logger.LogError(ex, "Error loading usage data for key {KeyId}", keyId);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task RefreshData()
    {
        if (keyId > 0)
        {
            await LoadDataAsync();
        }
    }
    
    private async Task RenderChartAsync()
    {
        try
        {
            // Group data by day
            var dailyData = usageData!
                .GroupBy(d => d.Timestamp.Date)
                .OrderBy(g => g.Key)
                .Select(g => new 
                {
                    Date = g.Key.ToString("MM/dd"),
                    Cost = g.Sum(r => r.Cost),
                    Requests = g.Count()
                })
                .ToList();
                
            var dates = dailyData.Select(d => d.Date).ToArray();
            var costs = dailyData.Select(d => (double)d.Cost).ToArray();
            var requests = dailyData.Select(d => d.Requests).ToArray();
            
            // Call the chart initialization method
            await Task.Run(() => InitChart(dates, costs, requests));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error rendering chart");
        }
    }
    
    private void InitChart(string[] labels, double[] costData, int[] requestData)
    {
        // This is a placeholder - you'd need to implement this with JSInterop
        // to actually render a Chart.js chart
    }
    
    private void ShowAllActivity()
    {
        // Navigate to a detailed view with all activity
        // You could implement this as a separate page or modal
    }
    
    // View model for request logs
    private class RequestLogViewModel
    {
        public int Id { get; set; }
        public int VirtualKeyId { get; set; }
        public string ModelName { get; set; } = string.Empty;
        public string RequestType { get; set; } = string.Empty;
        public int InputTokens { get; set; }
        public int OutputTokens { get; set; }
        public decimal Cost { get; set; }
        public double ResponseTimeMs { get; set; }
        public DateTime Timestamp { get; set; }
        public string? UserId { get; set; }
    }
}