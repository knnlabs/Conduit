@using ConduitLLM.WebUI.Models
@using ConduitLLM.WebUI.Services
@using ConduitLLM.WebUI.Components.Shared
@inject NotificationService NotificationService
@implements IDisposable
@rendermode InteractiveServer

<div class="notification-container">
    <button class="btn btn-icon notification-button" @onclick="ToggleNotificationPanel">
        <i class="fa fa-bell"></i>
        @if (UnreadCount > 0)
        {
            <span class="notification-badge">@UnreadCount</span>
        }
    </button>

    @if (IsOpen)
    {
        <div class="notification-dropdown">
            <div class="paper notification-panel">
                <div class="notification-header">
                    <h6 class="text-h6 mb-0 flex-grow-1">Notifications</h6>
                    <div class="notification-actions">
                        <Tooltip Text="Filter Notifications">
                            <button class="btn btn-sm btn-outlined" @onclick="ToggleFilterMenu">
                                <i class="fa fa-filter"></i>
                            </button>
                        </Tooltip>
                        <Tooltip Text="Mark All Read">
                            <button class="btn btn-sm btn-outlined" @onclick="MarkAllAsRead">
                                <i class="fa fa-check-double"></i>
                            </button>
                        </Tooltip>
                        <Tooltip Text="Clear Read Notifications">
                            <button class="btn btn-sm btn-outlined text-error" @onclick="ClearReadNotifications">
                                <i class="fa fa-trash"></i>
                            </button>
                        </Tooltip>
                    </div>
                </div>
                
                <hr class="divider my-0" />
                
                @if (ShowFilterMenu)
                {
                    <div class="notification-filter-menu">
                        <div class="filter-header">
                            <span class="text-caption">Filter by Type</span>
                        </div>
                        <div class="filter-options">
                            <label class="filter-option">
                                <input type="checkbox" @bind="ShowSystemNotifications" @bind:after="ApplyFilters" />
                                <span><i class="fa fa-info-circle"></i> System</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" @bind="ShowProviderNotifications" @bind:after="ApplyFilters" />
                                <span><i class="fa fa-heartbeat"></i> Provider Health</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" @bind="ShowModelNotifications" @bind:after="ApplyFilters" />
                                <span><i class="fa fa-search"></i> Model Discovery</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" @bind="ShowConfigNotifications" @bind:after="ApplyFilters" />
                                <span><i class="fa fa-cog"></i> Configuration</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" @bind="ShowBudgetNotifications" @bind:after="ApplyFilters" />
                                <span><i class="fa fa-exclamation-triangle"></i> Budget & Keys</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" @bind="ShowErrorNotifications" @bind:after="ApplyFilters" />
                                <span><i class="fa fa-exclamation-circle"></i> Errors & Security</span>
                            </label>
                        </div>
                    </div>
                    <hr class="divider my-0" />
                }
                
                <div class="notification-list">
                    @if (!Notifications.Any())
                    {
                        <div class="d-flex flex-column align-items-center p-4">
                            <i class="fa fa-inbox fa-2x text-secondary mb-2"></i>
                            <p class="text-body2 text-secondary text-center">No notifications</p>
                        </div>
                    }
                    else
                    {
                        <ul class="notification-items">
                            @foreach (var notification in Notifications)
                            {
                                <li class="@($"notification-item {GetNotificationClass(notification)}")">
                                    <div class="d-flex align-items-center w-100">
                                        <div class="notification-avatar @GetNotificationColorClass(notification)">
                                            <i class="@GetNotificationIconClass(notification)"></i>
                                        </div>
                                        
                                        <div class="notification-content">
                                            <p class="@(notification.IsRead ? "text-body1" : "text-body1 fw-medium")">
                                                @notification.Message
                                            </p>
                                            
                                            @if (!string.IsNullOrEmpty(notification.Source))
                                            {
                                                <small class="text-secondary d-block">
                                                    @notification.Source
                                                </small>
                                            }
                                            
                                            @if (!string.IsNullOrEmpty(notification.Details))
                                            {
                                                <small class="notification-details text-dark">
                                                    @notification.Details
                                                </small>
                                            }
                                            
                                            <small class="text-secondary d-block mt-1">
                                                @FormatTimeAgo(notification.Timestamp)
                                            </small>
                                        </div>
                                        
                                        @if (!notification.IsRead)
                                        {
                                            <button class="btn btn-icon btn-sm text-primary" @onclick="() => MarkAsRead(notification.Id)">
                                                <i class="fa fa-check"></i>
                                            </button>
                                        }
                                    </div>
                                </li>
                                <hr class="divider my-0" />
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>
    }
</div>

<style>
    .notification-container {
        position: relative;
    }
    
    .notification-button {
        position: relative;
        background: transparent;
        color: white;
    }
    
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #f44336;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 0.7rem;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid white;
    }
    
    .notification-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        z-index: 1000;
    }
    
    .notification-panel {
        width: 350px;
        max-height: 500px;
        z-index: 1000;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 4px;
    }
    
    .notification-header {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .notification-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .notification-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .notification-items {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .notification-item {
        opacity: 1;
        transition: background-color 0.2s ease;
        padding: 8px 16px;
    }
    
    .notification-item.read {
        opacity: 0.7;
    }
    
    .notification-item:hover {
        background-color: #f5f5f5;
    }
    
    .notification-item.info {
        border-left: 3px solid #2196f3;
    }
    
    .notification-item.warning {
        border-left: 3px solid #ff9800;
    }
    
    .notification-item.error {
        border-left: 3px solid #f44336;
    }
    
    .notification-item.success {
        border-left: 3px solid #4caf50;
    }
    
    .notification-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        color: white;
        font-size: 14px;
    }
    
    .notification-avatar.bg-info {
        background-color: #2196f3;
    }
    
    .notification-avatar.bg-warning {
        background-color: #ff9800;
    }
    
    .notification-avatar.bg-error {
        background-color: #f44336;
    }
    
    .notification-avatar.bg-success {
        background-color: #4caf50;
    }
    
    .notification-avatar.bg-default {
        background-color: #9e9e9e;
    }
    
    .notification-content {
        flex-grow: 1;
        font-size: 0.9rem;
    }
    
    .notification-details {
        white-space: pre-wrap;
        display: block;
    }
    
    .notification-filter-menu {
        padding: 12px 16px;
        background-color: #f8f9fa;
    }
    
    .filter-header {
        margin-bottom: 8px;
        font-weight: 600;
        color: #6c757d;
    }
    
    .filter-options {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .filter-option {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 4px 0;
        font-size: 0.875rem;
    }
    
    .filter-option:hover {
        color: #007bff;
    }
    
    .filter-option input[type="checkbox"] {
        margin-right: 8px;
    }
    
    .filter-option span {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .filter-option i {
        width: 16px;
        text-align: center;
    }
</style>

@code {
    private List<Notification> AllNotifications = new();
    private List<Notification> Notifications = new();
    private bool IsOpen = false;
    private int UnreadCount = 0;
    private bool ShowFilterMenu = false;
    
    // Filter state
    private bool ShowSystemNotifications = true;
    private bool ShowProviderNotifications = true;
    private bool ShowModelNotifications = true;
    private bool ShowConfigNotifications = true;
    private bool ShowBudgetNotifications = true;
    private bool ShowErrorNotifications = true;

    protected override void OnInitialized()
    {
        // Subscribe to notification event
        NotificationService.OnNotification += OnNotificationReceived;
        LoadNotifications();
    }

    private void OnNotificationReceived()
    {
        LoadNotifications();
        StateHasChanged();
    }

    private void LoadNotifications()
    {
        AllNotifications = NotificationService.GetNotifications(true).OrderByDescending(n => n.Timestamp).ToList();
        ApplyFilters();
    }
    
    private void ApplyFilters()
    {
        Notifications = AllNotifications.Where(n => ShouldShowNotification(n)).ToList();
        UnreadCount = Notifications.Count(n => !n.IsRead);
    }
    
    private bool ShouldShowNotification(Notification notification)
    {
        return notification.Type switch
        {
            NotificationType.System => ShowSystemNotifications,
            NotificationType.ProviderHealth => ShowProviderNotifications,
            NotificationType.ModelDiscovery => ShowModelNotifications,
            NotificationType.ConfigurationChange => ShowConfigNotifications,
            NotificationType.BudgetWarning => ShowBudgetNotifications,
            NotificationType.KeyExpiration => ShowBudgetNotifications,
            NotificationType.VirtualKeyValidation => ShowBudgetNotifications,
            NotificationType.Error => ShowErrorNotifications,
            NotificationType.Security => ShowErrorNotifications,
            NotificationType.SystemMaintenance => ShowSystemNotifications,
            NotificationType.Success => true, // Always show success
            _ => true
        };
    }
    
    private void ToggleFilterMenu()
    {
        ShowFilterMenu = !ShowFilterMenu;
    }

    private void ToggleNotificationPanel()
    {
        IsOpen = !IsOpen;
    }

    private void MarkAsRead(Guid id)
    {
        NotificationService.MarkAsRead(id);
        LoadNotifications();
    }

    private void MarkAllAsRead()
    {
        NotificationService.MarkAllAsRead();
        LoadNotifications();
    }

    private void ClearReadNotifications()
    {
        NotificationService.ClearReadNotifications();
        LoadNotifications();
    }

    private string FormatTimeAgo(DateTime time)
    {
        var span = DateTime.UtcNow - time;

        if (span.TotalDays > 30)
        {
            return $"{time:MMM d, yyyy}";
        }
        if (span.TotalDays > 1)
        {
            return $"{(int)span.TotalDays} days ago";
        }
        if (span.TotalHours > 1)
        {
            return $"{(int)span.TotalHours} hours ago";
        }
        if (span.TotalMinutes > 1)
        {
            return $"{(int)span.TotalMinutes} minutes ago";
        }
        return "Just now";
    }
    
    private string GetNotificationClass(Notification notification)
    {
        string baseClass = notification.IsRead ? "read" : "unread";
        
        return notification.Type switch
        {
            NotificationType.System => $"{baseClass} info",
            NotificationType.BudgetWarning => $"{baseClass} warning",
            NotificationType.KeyExpiration => $"{baseClass} warning",
            NotificationType.VirtualKeyValidation => $"{baseClass} warning",
            NotificationType.Security => $"{baseClass} error",
            NotificationType.Error => $"{baseClass} error",
            NotificationType.Success => $"{baseClass} success",
            NotificationType.ProviderHealth => $"{baseClass} info",
            NotificationType.ModelDiscovery => $"{baseClass} success",
            NotificationType.ConfigurationChange => $"{baseClass} info",
            NotificationType.SystemMaintenance => $"{baseClass} warning",
            _ => baseClass
        };
    }
    
    private string GetNotificationColorClass(Notification notification)
    {
        return notification.Type switch
        {
            NotificationType.System => "bg-info",
            NotificationType.BudgetWarning => "bg-warning",
            NotificationType.KeyExpiration => "bg-warning",
            NotificationType.VirtualKeyValidation => "bg-warning",
            NotificationType.Security => "bg-error",
            NotificationType.Error => "bg-error",
            NotificationType.Success => "bg-success",
            NotificationType.ProviderHealth => "bg-info",
            NotificationType.ModelDiscovery => "bg-success",
            NotificationType.ConfigurationChange => "bg-info",
            NotificationType.SystemMaintenance => "bg-warning",
            _ => "bg-default"
        };
    }
    
    private string GetNotificationIconClass(Notification notification)
    {
        return notification.Type switch
        {
            NotificationType.System => "fa fa-info",
            NotificationType.BudgetWarning => "fa fa-exclamation-triangle",
            NotificationType.KeyExpiration => "fa fa-exclamation-triangle",
            NotificationType.VirtualKeyValidation => "fa fa-exclamation-triangle",
            NotificationType.Security => "fa fa-exclamation-circle",
            NotificationType.Error => "fa fa-exclamation-circle",
            NotificationType.Success => "fa fa-check-circle",
            NotificationType.ProviderHealth => "fa fa-heartbeat",
            NotificationType.ModelDiscovery => "fa fa-search",
            NotificationType.ConfigurationChange => "fa fa-cog",
            NotificationType.SystemMaintenance => "fa fa-tools",
            _ => "fa fa-bell"
        };
    }

    public void Dispose()
    {
        // Unsubscribe from notification event
        NotificationService.OnNotification -= OnNotificationReceived;
    }
}