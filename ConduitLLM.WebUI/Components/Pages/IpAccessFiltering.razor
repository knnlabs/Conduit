@page "/ip-access-filtering"
@using ConduitLLM.Configuration.Constants
@using ConduitLLM.Configuration.DTOs.IpFilter
@using ConduitLLM.WebUI.Interfaces
@using ConduitLLM.WebUI.Models
@using ConduitLLM.WebUI.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Logging
@using ConduitLLM.WebUI.Components.Shared
@attribute [Authorize]
@inject IIpFilterService IpFilterService
@inject NotificationService NotificationService
@inject ILogger<IpAccessFiltering> Logger
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>IP Access Filtering - Conduit LLM</PageTitle>

<div class="container">
    <h1 class="mb-4">IP Access Filtering</h1>
    
    @if (_loading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading IP filtering data...</p>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-12">
                <!-- Global Settings Card -->
                <div class="card">
                    <div class="card-header">
                        <h3>Global Settings</h3>
                    </div>
                    <div class="card-body">
                        <!-- IP Filtering Toggle -->
                        <ToggleCard Title="IP Filtering"
                                    EnabledDescription="IP filtering is active. Only allowed IP addresses can access the API."
                                    DisabledDescription="IP filtering is disabled. All IP addresses can access the API."
                                    IsEnabled="_settings.IsEnabled"
                                    IsEnabledChanged="(value) => _settings.IsEnabled = value"
                                    EnabledButtonText="Disable"
                                    DisabledButtonText="Enable"
                                    EnabledBackgroundColor="#d4edda"
                                    DisabledBackgroundColor="#fff3cd" />

                        <div class="mt-4">
                            <div class="row mb-3">
                                <div class="col-12 col-md-6">
                                    <div class="form-group">
                                        <div class="form-check form-switch ps-0">
                                            <label class="form-check-label mb-2" for="defaultAllowSwitch">
                                                <strong>Default Allow</strong>
                                            </label>
                                            <div class="d-flex align-items-center">
                                                <input class="form-check-input ms-0 me-2" type="checkbox" id="defaultAllowSwitch"
                                                     @bind="_settings.DefaultAllow">
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">
                                            When enabled, IP addresses that don't match any rule are allowed.
                                            When disabled, IP addresses that don't match any rule are blocked.
                                        </small>
                                    </div>
                                </div>

                                <div class="col-12 col-md-6">
                                    <div class="form-group">
                                        <div class="form-check form-switch ps-0">
                                            <label class="form-check-label mb-2" for="bypassAdminUiSwitch">
                                                <strong>Bypass for Admin UI</strong>
                                            </label>
                                            <div class="d-flex align-items-center">
                                                <input class="form-check-input ms-0 me-2" type="checkbox" id="bypassAdminUiSwitch"
                                                     @bind="_settings.BypassForAdminUi">
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">
                                            When enabled, IP filtering rules are not applied to the admin UI.
                                            This allows administrators to access the UI even if their IP is blocked from API access.
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="excludedEndpoints"><strong>Excluded Endpoints</strong></label>
                                <textarea class="form-control" id="excludedEndpoints" rows="3"
                                          @bind="_excludedEndpointsText"></textarea>
                                <small class="form-text text-muted">
                                    List of endpoints excluded from IP filtering, one per line (e.g., /api/v1/health).
                                </small>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button class="btn btn-primary" @onclick="SaveSettingsAsync">
                                    <i class="bi bi-save"></i> Save Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-12">
                <!-- IP Rules Card -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>IP Filter Rules</h3>
                        <div>
                            <button class="btn btn-outline-secondary me-2" @onclick="RefreshFiltersAsync">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button class="btn btn-primary" @onclick="() => ShowFilterModal(null)">
                                <i class="bi bi-plus-circle"></i> Add New Filter
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (!_filters.Any())
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No IP filter rules have been created yet.
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-primary" @onclick="() => ShowFilterModal(null)">
                                        Add your first filter rule
                                    </button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>IP Address/CIDR</th>
                                            <th>Description</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var filter in _filters)
                                        {
                                            <tr>
                                                <td>
                                                    @if (filter.FilterType == IpFilterConstants.WHITELIST)
                                                    {
                                                        <span class="badge bg-success">Whitelist</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Blacklist</span>
                                                    }
                                                </td>
                                                <td><code>@filter.IpAddressOrCidr</code></td>
                                                <td>@(string.IsNullOrEmpty(filter.Description) ? "-" : filter.Description)</td>
                                                <td>
                                                    @if (filter.IsEnabled)
                                                    {
                                                        <span class="badge bg-success">Active</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">Disabled</span>
                                                    }
                                                </td>
                                                <td>@filter.CreatedAt.ToLocalTime().ToString("g")</td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button class="btn btn-sm btn-outline-primary"
                                                                @onclick="() => ShowFilterModal(filter)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger"
                                                                @onclick="() => ShowDeleteConfirmation(filter)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-12">
                <!-- Information Card -->
                <div class="card">
                    <div class="card-header">
                        <h3>About IP Filtering</h3>
                    </div>
                    <div class="card-body">
                        <h5>How IP Filtering Works</h5>
                        <p>
                            IP filtering allows you to control which IP addresses can access your Conduit API endpoints.
                            You can create both whitelist and blacklist rules to manage access.
                        </p>
                        
                        <h5>Rule Resolution Logic</h5>
                        <ol>
                            <li>If a client IP matches any <strong>whitelist</strong> rule, access is <strong>allowed</strong></li>
                            <li>If a client IP matches any <strong>blacklist</strong> rule, access is <strong>denied</strong></li>
                            <li>If you have any whitelist rules and the IP doesn't match any, access is <strong>denied</strong></li>
                            <li>If you have no whitelist rules and the IP doesn't match any blacklist rule, the Default Allow setting is used</li>
                        </ol>
                        
                        <h5>Supported Formats</h5>
                        <ul>
                            <li>Individual IPv4 addresses (e.g., <code>192.168.1.1</code>)</li>
                            <li>IPv4 CIDR subnet notations (e.g., <code>192.168.1.0/24</code>)</li>
                            <li>Individual IPv6 addresses (e.g., <code>2001:db8::1</code>)</li>
                            <li>IPv6 CIDR subnet notations (e.g., <code>2001:db8::/32</code>)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }
    
    <!-- Add/Edit IP Filter Modal -->
    <div class="modal fade @(_showFilterModal ? "show d-block" : "d-none")" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(_editingFilter is UpdateIpFilterDto ? "Edit" : "Add") IP Filter</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    @if (_editingFilter != null)
                    {
                        <div class="mb-3">
                            <label for="filterType" class="form-label">Filter Type</label>
                            @if (_editingFilter is CreateIpFilterDto createDto)
                            {
                                <select class="form-select" id="filterType" @bind="createDto.FilterType">
                                    <option value="@IpFilterConstants.WHITELIST">Whitelist (Allow)</option>
                                    <option value="@IpFilterConstants.BLACKLIST">Blacklist (Block)</option>
                                </select>
                            }
                            else if (_editingFilter is UpdateIpFilterDto updateDto)
                            {
                                <select class="form-select" id="filterType" @bind="updateDto.FilterType">
                                    <option value="@IpFilterConstants.WHITELIST">Whitelist (Allow)</option>
                                    <option value="@IpFilterConstants.BLACKLIST">Blacklist (Block)</option>
                                </select>
                            }
                            <small class="form-text text-muted">
                                Whitelist allows access only to specified IPs.
                                Blacklist blocks access to specified IPs.
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="ipAddressOrCidr" class="form-label">IP Address or CIDR Subnet</label>
                            @if (_editingFilter is CreateIpFilterDto createDto1)
                            {
                                <input type="text" class="form-control" id="ipAddressOrCidr"
                                       @bind="createDto1.IpAddressOrCidr"
                                       placeholder="e.g., 192.168.1.1 or 192.168.1.0/24" />
                            }
                            else if (_editingFilter is UpdateIpFilterDto updateDto1)
                            {
                                <input type="text" class="form-control" id="ipAddressOrCidr"
                                       @bind="updateDto1.IpAddressOrCidr"
                                       placeholder="e.g., 192.168.1.1 or 192.168.1.0/24" />
                            }
                            <small class="form-text text-muted">
                                Enter a single IP address or a CIDR subnet notation.
                            </small>
                            @if (!string.IsNullOrEmpty(_validationError))
                            {
                                <div class="text-danger mt-1">@_validationError</div>
                            }
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description (Optional)</label>
                            @if (_editingFilter is CreateIpFilterDto createDto2)
                            {
                                <input type="text" class="form-control" id="description"
                                       @bind="createDto2.Description"
                                       placeholder="e.g., Office network" />
                            }
                            else if (_editingFilter is UpdateIpFilterDto updateDto2)
                            {
                                <input type="text" class="form-control" id="description"
                                       @bind="updateDto2.Description"
                                       placeholder="e.g., Office network" />
                            }
                        </div>

                        <div class="mb-3 form-check">
                            <label class="form-check-label" for="isEnabled">Enabled</label>
                            @if (_editingFilter is CreateIpFilterDto createDto3)
                            {
                                <input type="checkbox" class="form-check-input" id="isEnabled"
                                       @bind="createDto3.IsEnabled" />
                            }
                            else if (_editingFilter is UpdateIpFilterDto updateDto3)
                            {
                                <input type="checkbox" class="form-check-input" id="isEnabled"
                                       @bind="updateDto3.IsEnabled" />
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveFilterAsync">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade @(_showDeleteModal ? "show d-block" : "d-none")" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    @if (_filterToDelete != null)
                    {
                        <p>
                            Are you sure you want to delete the following IP filter rule?
                        </p>
                        <div class="alert alert-warning">
                            <strong>Type:</strong> @(_filterToDelete.FilterType == IpFilterConstants.WHITELIST ? "Whitelist" : "Blacklist")<br />
                            <strong>IP/CIDR:</strong> @_filterToDelete.IpAddressOrCidr<br />
                            @if (!string.IsNullOrEmpty(_filterToDelete.Description))
                            {
                                <strong>Description:</strong> @_filterToDelete.Description<br />
                            }
                        </div>
                        <p class="text-danger">
                            This action cannot be undone.
                        </p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteFilterAsync">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Backdrop -->
    @if (_showFilterModal || _showDeleteModal)
    {
        <div class="modal-backdrop fade show"></div>
    }
</div>

@code {
    private bool _loading = true;
    private bool _showFilterModal = false;
    private bool _showDeleteModal = false;
    private string? _validationError;
    private string _excludedEndpointsText = string.Empty;

    private IpFilterSettings _settings = new();
    private List<IpFilterDto> _filters = new();
    private IpFilterDto? _filterToDelete;
    private object? _editingFilter; // Will store either CreateIpFilterDto or UpdateIpFilterDto
    
    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }
    
    private async Task LoadDataAsync()
    {
        try
        {
            _loading = true;
            StateHasChanged();
            
            // Load settings
            _settings = await IpFilterService.GetIpFilterSettingsAsync();
            
            // Convert excluded endpoints list to text
            _excludedEndpointsText = string.Join(Environment.NewLine, _settings.ExcludedEndpoints);
            
            // Load filters
            await RefreshFiltersAsync();
            
            _loading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading IP filtering data");
            NotificationService.AddNotification(NotificationType.Error, "Error loading IP filtering data", ex.Message);
            
            _loading = false;
            StateHasChanged();
        }
    }
    
    private async Task RefreshFiltersAsync()
    {
        try
        {
            var filters = await IpFilterService.GetAllFiltersAsync();
            _filters = filters.OrderBy(f => f.FilterType == IpFilterConstants.WHITELIST ? 0 : 1)
                             .ThenBy(f => f.IpAddressOrCidr)
                             .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing IP filters");
            NotificationService.AddNotification(NotificationType.Error, "Error refreshing IP filters", ex.Message);
        }
    }
    
    private async Task SaveSettingsAsync()
    {
        try
        {
            // Parse excluded endpoints from text
            _settings.ExcludedEndpoints = _excludedEndpointsText
                .Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(e => e.Trim())
                .Where(e => !string.IsNullOrEmpty(e))
                .ToList();
            
            var (success, errorMessage) = await IpFilterService.UpdateIpFilterSettingsAsync(_settings);
            
            if (success)
            {
                NotificationService.AddNotification(NotificationType.Success, 
                    "IP filtering settings saved successfully");
            }
            else
            {
                NotificationService.AddNotification(NotificationType.Error, 
                    "Error saving IP filtering settings", errorMessage);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving IP filtering settings");
            NotificationService.AddNotification(NotificationType.Error, 
                "Error saving IP filtering settings", ex.Message);
        }
    }
    
    private void ShowFilterModal(IpFilterDto? filter)
    {
        _validationError = null;

        if (filter == null)
        {
            // Creating a new filter
            _editingFilter = new CreateIpFilterDto
            {
                FilterType = IpFilterConstants.BLACKLIST,
                IpAddressOrCidr = string.Empty,
                Description = string.Empty,
                IsEnabled = true
            };
        }
        else
        {
            // Editing an existing filter (use UpdateIpFilterDto)
            _editingFilter = new UpdateIpFilterDto
            {
                Id = filter.Id,
                FilterType = filter.FilterType,
                IpAddressOrCidr = filter.IpAddressOrCidr,
                Description = filter.Description,
                IsEnabled = filter.IsEnabled
            };
        }

        // Show the modal
        _showFilterModal = true;
        StateHasChanged();
    }
    
    private void ShowDeleteConfirmation(IpFilterDto filter)
    {
        _filterToDelete = filter;
        _showDeleteModal = true;
        StateHasChanged();
    }
    
    private void CloseModals()
    {
        _showFilterModal = false;
        _showDeleteModal = false;
        _editingFilter = null;
        _filterToDelete = null;
        _validationError = null;
        StateHasChanged();
    }
    
    private async Task SaveFilterAsync()
    {
        if (_editingFilter == null)
        {
            CloseModals();
            return;
        }
        
        // Extract the IP address or CIDR for validation
        string ipAddressOrCidr = "";

        if (_editingFilter is CreateIpFilterDto createFilterDto)
        {
            ipAddressOrCidr = createFilterDto.IpAddressOrCidr;
        }
        else if (_editingFilter is UpdateIpFilterDto updateFilterDto)
        {
            ipAddressOrCidr = updateFilterDto.IpAddressOrCidr;
        }

        // Validate IP or CIDR format
        if (string.IsNullOrWhiteSpace(ipAddressOrCidr))
        {
            _validationError = "IP address or CIDR subnet cannot be empty.";
            StateHasChanged();
            return;
        }

        if (!ipAddressOrCidr.Contains('/'))
        {
            // Single IP address validation
            if (!IpAddressValidator.IsValidIpAddress(ipAddressOrCidr))
            {
                _validationError = "Invalid IP address format.";
                StateHasChanged();
                return;
            }
        }
        else
        {
            // CIDR notation validation
            if (!IpAddressValidator.IsValidCidr(ipAddressOrCidr))
            {
                _validationError = "Invalid CIDR subnet notation.";
                StateHasChanged();
                return;
            }
        }
        
        try
        {
            bool success;
            string? errorMessage = null;
            
            // Determine if this is a new filter or an update
            if (_editingFilter is UpdateIpFilterDto updateFilterDto)
            {
                // Update existing filter
                (success, errorMessage) = await IpFilterService.UpdateFilterAsync(updateFilterDto);
            }
            else if (_editingFilter is CreateIpFilterDto createFilterDto2)
            {
                // Create new filter
                var result = await IpFilterService.CreateFilterAsync(createFilterDto2);
                success = result.Success;
                errorMessage = result.ErrorMessage;
            }
            else
            {
                success = false;
                errorMessage = "Invalid filter type";
            }
            
            if (success)
            {
                NotificationService.AddNotification(NotificationType.Success, 
                    "IP filter saved successfully");
                    
                // Close modal and refresh filters
                CloseModals();
                await RefreshFiltersAsync();
            }
            else
            {
                _validationError = errorMessage ?? "An error occurred while saving the IP filter.";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving IP filter");
            _validationError = $"An error occurred: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task DeleteFilterAsync()
    {
        if (_filterToDelete == null || _filterToDelete.Id <= 0)
        {
            CloseModals();
            return;
        }
        
        try
        {
            var (success, errorMessage) = await IpFilterService.DeleteFilterAsync(_filterToDelete.Id);
            
            if (success)
            {
                NotificationService.AddNotification(NotificationType.Success, 
                    "IP filter deleted successfully");
                    
                // Close modal and refresh filters
                CloseModals();
                await RefreshFiltersAsync();
            }
            else
            {
                NotificationService.AddNotification(NotificationType.Error, 
                    "Error deleting IP filter", errorMessage);
                CloseModals();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting IP filter with ID {Id}", _filterToDelete.Id);
            NotificationService.AddNotification(NotificationType.Error,
                "Error deleting IP filter", ex.Message);
            CloseModals();
        }
    }
}