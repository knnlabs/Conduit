@page "/chat"
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Options
@using ConduitLLM.Core.Models
@using ConduitLLM.Configuration
@using ConduitLLM.Configuration.Entities
@using Microsoft.AspNetCore.Components.Rendering
@using ConduitLLM.WebUI.Components.Shared
@using System.Text.Json
@using System.Text.Json.Serialization
@using System.Text
@using System.Net.Http
@using System.Net.Http.Headers
@inject IDbContextFactory<ConfigurationDbContext> DbContextFactory
@inject IOptions<ConduitSettings> ConduitSettingsOptions
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Chat Playground</MudText>

    @if (modelMappings == null || !modelMappings.Any())
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
            No models configured. Please add models in the <MudLink Href="/configuration">Configuration</MudLink> page.
        </MudAlert>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudTextField T="string" Label="System Prompt (Optional)" 
                                 @bind-Value="systemPrompt" Lines="3" 
                                 Variant="Variant.Outlined" Class="mb-4"
                                 HelperText="Instructions that define the AI's behavior for the entire conversation (e.g., 'You are a helpful assistant', 'Respond as a SQL expert')" />
                    
                    <MudTextField T="string" Label="User Message" 
                                 @bind-Value="userMessage" Lines="5" 
                                 Variant="Variant.Outlined" Class="mb-4"
                                 Placeholder="Enter your message here..." />
                    
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                              OnClick="SendRequest" Disabled="@isLoading" 
                              StartIcon="@Icons.Material.Filled.Send" Class="mr-2">
                        @if (isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <MudText>Sending...</MudText>
                        }
                        else
                        {
                            <MudText>Send Request</MudText>
                        }
                    </MudButton>
                    
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" 
                              OnClick="ClearChat" Disabled="@isLoading"
                              StartIcon="@Icons.Material.Filled.ClearAll">
                        Clear
                    </MudButton>
                    
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mt-4">
                            @errorMessage
                        </MudAlert>
                    }
                    
                    <!-- Chat History Display -->
                    <MudPaper Elevation="0" Class="mt-4 pa-4" Style="max-height: 500px; overflow-y: auto; background-color: var(--mud-palette-background-grey);">
                        @if (!chatHistory.Any() && !isLoading)
                        {
                            <MudText Align="Align.Center" Color="Color.Secondary">
                                Chat history will appear here.
                            </MudText>
                        }
                        @foreach (var message in chatHistory)
                        {
                            <MudPaper Elevation="0" Class="@($"mb-3 pa-3 {GetMessageClass(message.Role)}")">
                                <MudText Typo="Typo.subtitle2" Style="text-transform: capitalize;">
                                    @message.Role
                                </MudText>
                                <MudDivider Class="my-1" />
                                @RenderMessageContent(message.Content ?? string.Empty)
                            </MudPaper>
                        }
                        @if (isLoading && _streamResponse)
                        {
                            <MudPaper Elevation="0" Class="mb-3 pa-3 assistant-message">
                                <MudText Typo="Typo.subtitle2">
                                    Assistant
                                </MudText>
                                <MudDivider Class="my-1" />
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            </MudPaper>
                        }
                        @if (isLoading && !_streamResponse)
                        {
                            <MudPaper Elevation="0" Class="mb-3 pa-3 assistant-message">
                                <MudText Typo="Typo.subtitle2">
                                    Assistant
                                </MudText>
                                <MudDivider Class="my-1" />
                                <MudText Color="Color.Secondary">
                                    Waiting for response... <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="ml-2" />
                                </MudText>
                            </MudPaper>
                        }
                    </MudPaper>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12" md="4">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4">Parameters</MudText>
                    
                    <MudSelect T="string" Label="Model" @bind-Value="selectedModelAlias" 
                               Variant="Variant.Outlined" Class="mb-4" FullWidth="true"
                               AnchorOrigin="Origin.BottomCenter">
                        @foreach (var mapping in modelMappings)
                        {
                            <MudSelectItem Value="@mapping.ModelAlias">@mapping.ModelAlias</MudSelectItem>
                        }
                    </MudSelect>
                    
                    <MudTextField T="string" Label="API Key (Optional)" 
                                 @bind-Value="apiKey" Variant="Variant.Outlined" 
                                 HelperText="Overrides key from configuration for this request."
                                 Class="mb-4" />
                    
                    <MudSwitch T="bool"
                               Label="Stream Response"
                               Color="Color.Primary"
                               HelperText="Stream the response word-by-word, like ChatGPT."
                               @bind-Checked="_streamResponse"
                               Style="width: 100%"
                               Class="mb-2" />
                    
                    <MudSwitch T="bool"
                               Label="Show Raw Message"
                               Color="Color.Primary"
                               @bind-Checked="_showRawMessage"
                               Style="width: 100%"
                               Class="mb-2" />
                    
                    <MudSwitch T="bool"
                               Label="Append Function Result"
                               HelperText="Append the result of successful function calls to the chat history."
                               Color="Color.Primary"
                               @bind-Checked="_appendFunctionResult" />
                    
                    <MudSwitch T="bool"
                               Label="Execute Functions"
                               Color="Color.Primary"
                               @bind-Checked="_executeFunctions" />
                    
                    <MudText Typo="Typo.subtitle2" Class="mb-1">Temperature: @temperature</MudText>
                    <MudSlider T="double" Value="@temperature" ValueChanged="@((double val) => temperature = val)" 
                               Min="0" Max="1" Step="0.01" Class="mb-4" />
                    
                    <MudText Typo="Typo.subtitle2" Class="mb-1">Top P: @topP</MudText>
                    <MudSlider T="double" Value="@topP" ValueChanged="@((double val) => topP = val)" 
                               Min="0" Max="1" Step="0.01" Class="mb-4" />
                    
                    <MudTextField T="string" Label="Stop Sequences (Optional)" 
                                 @bind-Value="stopSequences" Variant="Variant.Outlined" 
                                 HelperText="Comma-separated list of sequences to stop generation."
                                 Class="mb-4" />
                    
                    <MudSwitch T="bool" 
                               Label="Auto Scroll"
                               HelperText="Automatically scroll to the bottom when new messages arrive."
                               @bind-Checked="_autoScroll"
                               Class="mb-2" />
                    
                    <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="ClearChat" Class="mt-4">Clear Chat</MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<style>
    .user-message {
        background-color: var(--mud-palette-primary-lighten);
        border-left: 4px solid var(--mud-palette-primary);
    }
    
    .assistant-message {
        background-color: var(--mud-palette-secondary-lighten);
        border-left: 4px solid var(--mud-palette-secondary);
    }
    
    .system-message {
        background-color: var(--mud-palette-info-lighten);
        border-left: 4px solid var(--mud-palette-info);
    }
</style>

@code {
    private ConduitSettings settings => ConduitSettingsOptions.Value;
    private List<ConduitLLM.Configuration.Entities.ModelProviderMapping> modelMappings = new();
    private string selectedModelAlias = "";
    private string systemPrompt = "";
    private string userMessage = "";
    private string apiKey = "";
    private string stopSequences = "";
    private double temperature = 0.7;
    private double topP = 1.0;
    private bool _streamResponse = true;
    private bool isLoading = false;
    private string errorMessage = "";
    private string _proxyBaseUrl = "";
    private List<Message> chatHistory = new();
    private string? streamedResponse = null;
    private bool _autoScroll = true;
    private bool _showRawMessage = false;
    private bool _appendFunctionResult = false;
    private bool _executeFunctions = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProxyUrlAsync();
        await LoadModelMappingsFromDatabase();
        // No need to call StateHasChanged here, Blazor handles it after OnInitializedAsync
    }

    private async Task LoadModelMappingsFromDatabase()
    {
        try
        {
            using var dbContext = await DbContextFactory.CreateDbContextAsync();
            modelMappings = await dbContext.ModelProviderMappings.ToListAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading model mappings: {ex.Message}");
            modelMappings = new List<ConduitLLM.Configuration.Entities.ModelProviderMapping>();
        }
    }

    private async Task LoadProxyUrlAsync()
    {
        try 
        {
            await Task.Run(() => {
                _proxyBaseUrl = "http://localhost:5000";
            });
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading proxy URL: {ex.Message}");
            _proxyBaseUrl = "";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task SendRequest()
    {
        if (string.IsNullOrWhiteSpace(userMessage) || string.IsNullOrWhiteSpace(selectedModelAlias))
        {
            errorMessage = "Please select a model and enter a user message.";
            return;
        }

        isLoading = true;
        errorMessage = "";
        
        try
        {
            // Add user message to chat history
            var userChatMessage = new Message { Role = "user", Content = userMessage };
            chatHistory.Add(userChatMessage);
            
            // Add system message if provided
            var messages = new List<Message>();
            if (!string.IsNullOrWhiteSpace(systemPrompt))
            {
                messages.Add(new Message { Role = "system", Content = systemPrompt });
            }
            messages.Add(userChatMessage);
            
            // Reset user message input
            var temp = userMessage;
            userMessage = "";
            
            // Convert messages to array for request
            var messagesArray = messages.ToArray();
            
            // Create request payload
            var chatRequest = new ChatCompletionRequest
            {
                Model = selectedModelAlias,
                Messages = messagesArray.ToList(), // Convert array to list
                Temperature = temperature, 
                TopP = topP, 
                Stop = !string.IsNullOrEmpty(stopSequences) ? 
                    stopSequences.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList() : null,
                Stream = _streamResponse
            };

            var httpClient = new HttpClient();
            var requestUri = $"{_proxyBaseUrl}/v1/chat/completions";
            
            // Add API key if provided
            if (!string.IsNullOrEmpty(apiKey))
            {
                httpClient.DefaultRequestHeaders.Authorization = 
                    new AuthenticationHeaderValue("Bearer", apiKey);
            }
            
            // Convert to JSON
            var jsonRequest = JsonSerializer.Serialize(chatRequest, new JsonSerializerOptions 
            { 
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
            });
            
            var content = new StringContent(jsonRequest, Encoding.UTF8, "application/json");
            
            if (_streamResponse)
            {
                // Handle streaming response
                streamedResponse = ""; // Reset the streamed response
                var response = await httpClient.PostAsync(requestUri, content);
                
                if (!response.IsSuccessStatusCode)
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    ProcessErrorResponse(response.StatusCode, errorContent);
                    return;
                }
                
                using var stream = await response.Content.ReadAsStreamAsync();
                using var reader = new StreamReader(stream);
                
                // Add assistant message to chat history
                chatHistory.Add(new Message { Role = "assistant", Content = "" });
                
                // Read the SSE stream
                while (!reader.EndOfStream)
                {
                    var line = await reader.ReadLineAsync();
                    if (string.IsNullOrEmpty(line) || !line.StartsWith("data: "))
                        continue;
                        
                    var jsonData = line.Substring(6); // Remove "data: " prefix
                    
                    if (jsonData == "[DONE]")
                        break;
                        
                    try
                    {
                        var streamResponse = JsonSerializer.Deserialize<ChatCompletionChunk>(jsonData);
                        ProcessStreamResponse(streamResponse);
                    }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Error parsing stream response: {ex}");
                    }
                }
                
                // Final message is complete
                if (!string.IsNullOrEmpty(streamedResponse))
                {
                    // Update the last message (assistant) with complete content
                    var lastMessage = chatHistory.LastOrDefault();
                    if (lastMessage != null && lastMessage.Role == "assistant")
                    {
                        lastMessage.Content = streamedResponse;
                    }
                }
            }
            else
            {
                // Handle non-streaming response
                var response = await httpClient.PostAsync(requestUri, content);
                var responseContent = await response.Content.ReadAsStringAsync();
                
                if (!response.IsSuccessStatusCode)
                {
                    ProcessErrorResponse(response.StatusCode, responseContent);
                    return;
                }

                try
                {
                    var chatResponse = JsonSerializer.Deserialize<ChatCompletionResponse>(
                        responseContent, 
                        new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
                    );
                    
                    if (chatResponse?.Choices != null && chatResponse.Choices.Count > 0)
                    {
                        var assistantMessage = chatResponse.Choices[0].Message;
                        chatHistory.Add(new Message
                        {
                            Role = assistantMessage.Role,
                            Content = assistantMessage.Content
                        });
                    }
                    else
                    {
                        errorMessage = "No response content received.";
                        return;
                    }
                }
                catch (Exception ex)
                {
                    errorMessage = $"Error parsing response: {ex.Message}";
                    Console.Error.WriteLine(ex.ToString());
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Request failed: {ex.Message}";
            Console.Error.WriteLine(ex.ToString());
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void ProcessStreamResponse(ChatCompletionChunk? streamResponse)
    {
        if (streamResponse?.Choices == null || streamResponse.Choices.Count == 0)
            return;
            
        var choice = streamResponse.Choices[0];
        var delta = choice.Delta;
        
        if (delta == null)
            return;
            
        // If there's content, append it
        if (!string.IsNullOrEmpty(delta.Content))
        {
            streamedResponse += delta.Content;
            
            // Update the last message in chat history
            var lastMessage = chatHistory.LastOrDefault();
            if (lastMessage != null && lastMessage.Role == "assistant")
            {
                lastMessage.Content = streamedResponse;
                StateHasChanged();
            }
        }
    }
    
    private void ProcessErrorResponse(System.Net.HttpStatusCode statusCode, string content)
    {
        try
        {
            var errorJson = JsonSerializer.Deserialize<JsonElement>(content);
            
            if (errorJson.TryGetProperty("error", out var errorProp))
            {
                if (errorProp.TryGetProperty("message", out var messageProp))
                {
                    errorMessage = messageProp.GetString() ?? "Unknown error";
                }
                else
                {
                    errorMessage = errorProp.ToString();
                }
            }
            else
            {
                errorMessage = $"API Error: {statusCode}";
            }
        }
        catch
        {
            errorMessage = $"API Error: {statusCode}";
        }
    }
    
    private string[]? ParseStopSequences(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return null;
            
        return input.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
    }
    
    private void ClearChat()
    {
        chatHistory.Clear();
        streamedResponse = null;
        errorMessage = "";
    }
    
    private string GetMessageClass(string role)
    {
        return role switch
        {
            "user" => "user-message",
            "assistant" => "assistant-message",
            "system" => "system-message",
            _ => ""
        };
    }
    
    private RenderFragment RenderMessageContent(object content) => builder =>
    {
        // Handle null content
        if (content == null)
        {
            builder.OpenElement(0, "pre");
            builder.AddAttribute(1, "style", "white-space: pre-wrap; word-wrap: break-word; margin-bottom: 0;");
            builder.AddContent(2, string.Empty);
            builder.CloseElement();
            return;
        }

        try
        {
            if (content is string strContent)
            {
                // Display plain string content
                builder.OpenElement(0, "pre");
                builder.AddAttribute(1, "style", "white-space: pre-wrap; word-wrap: break-word; margin-bottom: 0;");
                builder.AddContent(2, strContent);
                builder.CloseElement();
                return;
            }
            
            // Try to handle content as JsonElement
            if (content is JsonElement jsonElement)
            {
                if (jsonElement.ValueKind == JsonValueKind.String)
                {
                    // It's a plain string inside a JsonElement
                    builder.OpenElement(0, "pre");
                    builder.AddAttribute(1, "style", "white-space: pre-wrap; word-wrap: break-word; margin-bottom: 0;");
                    builder.AddContent(2, jsonElement.GetString());
                    builder.CloseElement();
                    return;
                }
                else if (jsonElement.ValueKind == JsonValueKind.Array)
                {
                    // It's an array of content parts
                    foreach (var element in jsonElement.EnumerateArray())
                    {
                        RenderContentPart(builder, element);
                    }
                    return;
                }
            }
            
            // Try to serialize and deserialize as content parts
            var json = JsonSerializer.Serialize(content);
            using var doc = JsonDocument.Parse(json);
            var root = doc.RootElement;
            
            if (root.ValueKind == JsonValueKind.Array)
            {
                // It's an array - render each part
                foreach (var element in root.EnumerateArray())
                {
                    RenderContentPart(builder, element);
                }
                return;
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error rendering content: {ex.Message}");
        }
        
        // Fallback - just render the string representation
        builder.OpenElement(0, "pre");
        builder.AddAttribute(1, "style", "white-space: pre-wrap; word-wrap: break-word; margin-bottom: 0;");
        builder.AddContent(2, content.ToString());
        builder.CloseElement();
    };
    
    /// <summary>
    /// Renders a single content part based on its type (text or image)
    /// </summary>
    private void RenderContentPart(RenderTreeBuilder builder, JsonElement element)
    {
        try
        {
            if (element.TryGetProperty("type", out var typeElement))
            {
                var type = typeElement.GetString();
                
                if (type == "text" && element.TryGetProperty("text", out var textElement))
                {
                    // Text content part
                    builder.OpenElement(0, "div");
                    builder.AddAttribute(1, "class", "mb-2");
                    builder.OpenElement(2, "pre");
                    builder.AddAttribute(3, "style", "white-space: pre-wrap; word-wrap: break-word; margin-bottom: 0;");
                    builder.AddContent(4, textElement.GetString());
                    builder.CloseElement(); // Close pre
                    builder.CloseElement(); // Close div
                }
                else if (type == "image_url" && element.TryGetProperty("image_url", out var imageUrlElement))
                {
                    // Image content part
                    if (imageUrlElement.TryGetProperty("url", out var urlElement))
                    {
                        var url = urlElement.GetString();
                        if (!string.IsNullOrEmpty(url))
                        {
                            builder.OpenElement(0, "div");
                            builder.AddAttribute(1, "class", "my-3");
                            
                            // Image element
                            builder.OpenElement(2, "img");
                            builder.AddAttribute(3, "src", url);
                            builder.AddAttribute(4, "class", "mud-elevation-1 rounded");
                            builder.AddAttribute(5, "style", "max-width: 100%; max-height: 400px;");
                            builder.AddAttribute(6, "alt", "AI generated image");
                            builder.CloseElement(); // Close img
                            
                            builder.CloseElement(); // Close div
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error rendering content part: {ex.Message}");
        }
    }
}
