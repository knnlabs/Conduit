@page "/configuration"
@using System.Text.Json
@using ConduitLLM.Configuration
@using ConfigDTOs = ConduitLLM.Configuration.DTOs
@using WebUIDTOs = ConduitLLM.WebUI.DTOs
@using ConduitLLM.Providers.Configuration
@using ConduitLLM.WebUI.Services
@using ConduitLLM.WebUI.Interfaces
@using Microsoft.Extensions.Logging
@using System.Collections.Generic
@using System.Linq
@using System.Threading.Tasks
@using Microsoft.JSInterop

@inject NavigationManager NavigationManager
@inject ILogger<Configuration> Logger
@inject Interfaces.IAdminApiClient AdminApiClient
@inject ConfigurationChangeNotifier ConfigChangeNotifier
@inject IJSRuntime JSRuntime
@inject ProviderModelsService ProviderModelsService
@rendermode InteractiveServer

<PageTitle>Configuration - ConduitLLM</PageTitle>

<div class="container container-xxl mt-4">
    <!-- Header Section -->
    <PageHeader Title="Configuration Management" 
                Description="Configure LLM providers, model mappings, and system settings for your deployment"
                Icon="fa-cogs">
        <Statistics>
            <div class="stat-item">
                <i class="fa fa-cloud me-2"></i>
                <span class="small">@(providerCredentials?.Count ?? 0) Providers</span>
            </div>
            <div class="stat-item mt-2">
                <i class="fa fa-sitemap me-2"></i>
                <span class="small">@(modelMappings?.Count ?? 0) Mappings</span>
            </div>
        </Statistics>
    </PageHeader>

    @if (!string.IsNullOrEmpty(deleteErrorMessage))
    {
        <div class="alert alert-danger border-0 shadow-sm mb-4">
            <i class="fa fa-exclamation-circle me-2"></i>
            @deleteErrorMessage
        </div>
    }

    <!-- LLM Providers Section -->
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-light border-0">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fa fa-cloud me-2 text-primary"></i>LLM Providers
                </h5>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle shadow-sm" type="button" id="addProviderDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-plus me-1"></i> Add Provider
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="addProviderDropdown">
                        @foreach (var provider in _supportedProviders)
                        {
                            <li><button class="dropdown-item" @onclick="() => LaunchGuidedSetup(provider)">
                                <i class="fa fa-plus me-2"></i>@provider
                            </button></li>
                        }
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            @if (providerCredentials == null)
            {
                <LoadingSpinner Message="Loading providers..." />
            }
            else if (!providerCredentials.Any())
            {
                <EmptyState Title="No Providers Configured"
                            Description="Get started by adding your first LLM provider"
                            Icon="fa-cloud"
                            IconOpacity="opacity-50" />

                <div class="row">
                    @foreach (var provider in _supportedProviders)
                    {
                        <div class="col-12 col-sm-6 col-lg-4 mb-4">
                            <div class="card h-100 provider-card shadow-sm border-0 hover-card">
                                <div class="card-header bg-light border-0">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fa fa-server me-2"></i>@provider
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text text-muted">
                                        @GetProviderDescription(provider)
                                    </p>
                                </div>
                                <div class="card-footer bg-transparent border-0">
                                    <button class="btn btn-primary w-100 shadow-sm" @onclick="() => LaunchGuidedSetup(provider)">
                                        <i class="fa fa-plus me-1"></i> Setup @provider
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="border-0 fw-semibold">
                                    <i class="fa fa-server me-2"></i>Provider
                                </th>
                                <th class="border-0 fw-semibold">
                                    <i class="fa fa-key me-2"></i>API Key
                                </th>
                                <th class="border-0 fw-semibold">
                                    <i class="fa fa-link me-2"></i>Base URL
                                </th>
                                <th class="border-0 fw-semibold text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var context in providerCredentials)
                            {
                                <tr class="border-light">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="provider-icon bg-primary-light rounded-circle p-2 me-3">
                                                <i class="fa fa-cloud text-primary"></i>
                                            </div>
                                            <span class="fw-semibold">@context.ProviderName</span>
                                        </div>
                                    </td>
                                    <td>
                                        @if (string.IsNullOrEmpty(context.ApiKey))
                                        {
                                            <span class="badge bg-warning text-dark">Not configured</span>
                                        }
                                        else
                                        {
                                            <span class="text-success">
                                                <i class="fa fa-check-circle me-1"></i>••••••••
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <code class="text-muted">@(string.IsNullOrEmpty(context.ApiBase) ? "Default" : context.ApiBase)</code>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="() => EditProvider(context.Id)">
                                                <i class="fa fa-edit me-1"></i>Edit
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => DeleteProvider(context.Id)">
                                                <i class="fa fa-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Model Mappings Section -->
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-light border-0">
            <h5 class="mb-0">
                <i class="fa fa-sitemap me-2 text-success"></i>Model Mappings
            </h5>
        </div>
        
        <div class="card-body">
            <div class="alert alert-info border-0 shadow-sm mb-4">
                <i class="fa fa-info-circle me-2"></i>
                <strong>Model Mappings:</strong> Create user-friendly aliases for your LLM models. 
                For example, map "gpt4" to OpenAI's "gpt-4-turbo-preview" model.
            </div>
            
            @if (modelMappings == null)
            {
                <LoadingSpinner Message="Loading model mappings..." />
            }
            else if (!modelMappings.Any())
            {
                <EmptyState Title="No Model Mappings"
                            Description="Create your first model mapping to get started"
                            Icon="fa-sitemap"
                            IconOpacity="opacity-50" />
            }
            else
            {
                <div class="table-responsive mb-4">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Model Alias</th>
                                <th>Provider</th>
                                <th>Provider Model</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var context in modelMappings)
                            {
                                <tr>
                                    <td>@context.ModelId</td>
                                    <td>@GetProviderNameById(context.ProviderId)</td>
                                    <td>@context.ProviderModelId</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="() => HandleEditMapping(context.Id)">
                                                <i class="fa fa-edit me-1"></i> Edit
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => DeleteMapping(context.Id)">
                                                <i class="fa fa-trash me-1"></i> Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            
            <button class="btn btn-primary shadow-sm" 
                  @onclick="() => { isEditingMapping = true; currentMapping = new MappingFormModel { ModelAlias = string.Empty, ProviderName = string.Empty, ProviderModelId = string.Empty, Id = 0 }; mappingErrorMessage = null; }">
                <i class="fa fa-plus me-1"></i> Add Model Mapping
            </button>
        </div>
    </div>

    @if (isEditingMapping)
    {
        <div class="card shadow-sm border-0 mb-5">
            <div class="card-header bg-light border-0">
                <h5 class="mb-0">
                    <i class="fa fa-@(currentMapping.ModelAlias == null ? "plus" : "edit") me-2 text-primary"></i>
                    @(currentMapping.ModelAlias == null ? "Add" : "Edit") Model Mapping
                </h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(mappingErrorMessage))
                {
                    <div class="alert alert-danger border-0 shadow-sm mb-4">
                        <i class="fa fa-exclamation-circle me-2"></i>
                        @mappingErrorMessage
                    </div>
                }
                
                <div class="form-group mb-4">
                    <label for="modelAlias">Model Alias</label>
                    <input type="text" class="form-control" id="modelAlias" 
                           @bind="currentMapping.ModelAlias" />
                    <small class="form-text text-muted">The friendly name you'll use in your code (e.g., 'gpt4', 'claude-latest')</small>
                </div>
                
                <div class="form-group mb-4">
                    <label for="providerName">Provider</label>
                    <select class="form-select" id="providerName" 
                            value="@currentMapping.ProviderName"
                            @onchange="@(async (ChangeEventArgs e) => { currentMapping.ProviderName = e.Value?.ToString() ?? ""; await LoadModelsForSelectedProvider(); })">
                        <option value="">-- Select Provider --</option>
                        @if (providerCredentials != null)
                        {
                            @foreach (var provider in providerCredentials.OrderBy(p => p.ProviderName))
                            {
                                <option value="@provider.ProviderName">@provider.ProviderName</option>
                            }
                        }
                    </select>
                </div>
                
                <div class="form-group mb-4">
                    <label for="providerModelId">Provider Model ID</label>
                    
                    @if (isLoadingModels)
                    {
                        <div class="d-flex align-items-center">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Loading models...</span>
                        </div>
                    }
                    else if (showModelTextbox || (!availableModels.Any() && !string.IsNullOrEmpty(currentMapping.ProviderName)))
                    {
                        <div>
                            <input type="text" class="form-control" id="providerModelIdInput"
                                   @bind="currentMapping.ProviderModelId"
                                   placeholder="Enter model ID"
                                   disabled="@string.IsNullOrEmpty(currentMapping.ProviderName)" />
                            
                            @if (!availableModels.Any() && !string.IsNullOrEmpty(currentMapping.ProviderName))
                            {
                                <small class="text-muted mt-1 d-block">
                                    Could not retrieve model list. Please enter the model ID manually.
                                </small>
                            }
                            
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        @onclick="RefreshModelsList"
                                        disabled="@(isLoadingModels || string.IsNullOrEmpty(currentMapping.ProviderName))">
                                    <i class="fa fa-refresh me-1"></i> Try loading models again
                                </button>
                                
                                @if (showModelTextbox && availableModels.Any())
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2"
                                            @onclick="ToggleModelInputMode">
                                        <i class="fa fa-list me-1"></i> Show dropdown
                                    </button>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="input-group">
                            <select class="form-select" id="providerModelId"
                                    @bind="currentMapping.ProviderModelId"
                                    disabled="@(isLoadingModels || string.IsNullOrEmpty(currentMapping.ProviderName))">
                                @if (string.IsNullOrEmpty(currentMapping.ProviderName))
                                {
                                    <option value="">Select a provider first</option>
                                }
                                else
                                {
                                    <option value="">-- Select a model --</option>
                                    @foreach (var model in availableModels.OrderBy(m => m))
                                    {
                                        <option value="@model">@model</option>
                                    }
                                }
                            </select>
                            <button class="btn btn-outline-secondary" type="button"
                                    @onclick="RefreshModelsList"
                                    disabled="@(isLoadingModels || string.IsNullOrEmpty(currentMapping.ProviderName))">
                                <i class="fa fa-refresh"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button"
                                    @onclick="ToggleModelInputMode"
                                    disabled="@(isLoadingModels || string.IsNullOrEmpty(currentMapping.ProviderName))">
                                <i class="fa fa-pencil"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">Select from available models or click <i class="fa fa-pencil"></i> to enter manually</small>
                    }
                </div>
                
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-secondary me-2" @onclick="() => isEditingMapping = false">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveMapping">Save</button>
                </div>
            </div>
        </div>
    }

    <!-- Global Settings Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="fa fa-globe me-2 text-info"></i>Global Settings
            </h3>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fa fa-link me-2 text-primary"></i>Proxy Base URL
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="proxyBaseUrl">Conduit Proxy Base URL</label>
                        <input type="text" class="form-control" id="proxyBaseUrl" 
                               @bind="proxyBaseUrlInput"
                               placeholder="e.g., https://api.yourcompany.com/conduit" />
                        <small class="form-text text-muted">URL where your Conduit API is publicly accessible. Used for SDK clients.</small>
                    </div>
                    
                    <button class="btn btn-primary shadow-sm mt-2" 
                            @onclick="SaveProxyUrl">
                        <i class="fa fa-save me-1"></i>Save
                    </button>
                    
                    @if (!string.IsNullOrEmpty(proxyUrlSaveMessage))
                    {
                        <div class="alert alert-success border-0 shadow-sm mt-3">
                            <i class="fa fa-check-circle me-2"></i>
                            @proxyUrlSaveMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 mb-5">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fa fa-refresh me-2 text-warning"></i>HTTP Retry Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-4">
                        <label for="maxRetries">Maximum Retry Attempts</label>
                        <input type="number" class="form-control" id="maxRetries" 
                               min="0" max="10"
                               @bind="httpRetryOptions.MaxRetries" />
                        <small class="form-text text-muted">Maximum number of times to retry HTTP requests on transient failures (0-10)</small>
                    </div>
                    
                    <div class="form-group mb-4">
                        <label for="initialDelay">Initial Delay (seconds)</label>
                        <input type="number" class="form-control" id="initialDelay" 
                               min="0" max="10"
                               @bind="httpRetryOptions.InitialDelaySeconds" />
                        <small class="form-text text-muted">Initial delay before first retry attempt</small>
                    </div>
                    
                    <div class="form-group mb-4">
                        <label for="maxDelay">Maximum Delay (seconds)</label>
                        <input type="number" class="form-control" id="maxDelay" 
                               min="1" max="60"
                               @bind="httpRetryOptions.MaxDelaySeconds" />
                        <small class="form-text text-muted">Maximum delay cap for any retry attempt</small>
                    </div>
                    
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="enableRetryLogging" 
                               @bind="httpRetryOptions.EnableRetryLogging" />
                        <label class="form-check-label" for="enableRetryLogging">
                            Enable Retry Logging
                        </label>
                    </div>
                    
                    <button class="btn btn-primary mb-2" 
                            @onclick="async () => await SaveHttpRetryOptions()">
                        <i class="fa fa-save me-1"></i> Save Retry Settings
                    </button>
                    
                    @if (!string.IsNullOrEmpty(httpRetryOptionsSaveMessage))
                    {
                        <div class="alert alert-success mt-3">
                            @httpRetryOptionsSaveMessage
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 mb-5">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fa fa-clock-o me-2 text-danger"></i>HTTP Timeout Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-4">
                        <label for="timeoutDuration">Timeout Duration (seconds)</label>
                        <input type="number" class="form-control" id="timeoutDuration" 
                               min="10" max="600"
                               @bind="httpTimeoutOptions.TimeoutSeconds" />
                        <small class="form-text text-muted">Maximum time to wait for HTTP requests to complete before timing out (10-600 seconds)</small>
                    </div>
                    
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="enableTimeoutLogging" 
                               @bind="httpTimeoutOptions.EnableTimeoutLogging" />
                        <label class="form-check-label" for="enableTimeoutLogging">
                            Enable Timeout Logging
                        </label>
                        <small class="d-block text-muted ms-4 mb-4">
                            Log detailed information about request timeouts
                        </small>
                    </div>
                    
                    <button class="btn btn-primary mb-2" 
                            @onclick="async () => await SaveHttpTimeoutOptions()">
                        <i class="fa fa-save me-1"></i> Save Timeout Settings
                    </button>
                    
                    @if (!string.IsNullOrEmpty(httpTimeoutOptionsSaveMessage))
                    {
                        <div class="alert alert-success mt-3">
                            @httpTimeoutOptionsSaveMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 mb-5">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fa fa-info-circle me-2 text-info"></i>About HTTP Client Settings
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">
                        These settings control how ConduitLLM handles retry logic when communicating with LLM provider APIs.
                    </p>
                    <div class="bg-light p-4 border rounded">
                        <div class="d-flex mb-3">
                            <i class="fa fa-refresh me-3 mt-1"></i>
                            <div>
                                <strong>Maximum Retry Attempts</strong>: Number of times the system will retry failed API calls that encounter transient errors.
                            </div>
                        </div>
                        <div class="d-flex mb-3">
                            <i class="fa fa-clock-o me-3 mt-1"></i>
                            <div>
                                <strong>Initial Delay</strong>: How long to wait before the first retry attempt. Subsequent retries use exponential backoff with jitter.
                            </div>
                        </div>
                        <div class="d-flex mb-3">
                            <i class="fa fa-hourglass-half me-3 mt-1"></i>
                            <div>
                                <strong>Maximum Delay</strong>: The maximum time to wait between retry attempts, regardless of the backoff calculation.
                            </div>
                        </div>
                        <div class="d-flex">
                            <i class="fa fa-bell me-3 mt-1"></i>
                            <div>
                                <strong>Enable Retry Logging</strong>: When enabled, detailed logs will be generated for each retry attempt, helping with troubleshooting.
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        These settings apply to all provider clients and provide resilience against temporary API outages and rate limiting.
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card shadow-sm border-0 mb-5">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fa fa-info-circle me-2 text-info"></i>About HTTP Timeout Settings
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">
                        These settings control how ConduitLLM handles timeouts when communicating with LLM provider APIs.
                    </p>
                    <div class="bg-light p-4 border rounded">
                        <div class="d-flex mb-3">
                            <i class="fa fa-hourglass-end me-3 mt-1"></i>
                            <div>
                                <strong>Timeout Duration</strong>: Maximum time to wait for HTTP requests to complete before timing out.
                            </div>
                        </div>
                        <div class="d-flex">
                            <i class="fa fa-bell me-3 mt-1"></i>
                            <div>
                                <strong>Enable Timeout Logging</strong>: When enabled, detailed logs will be generated for each request timeout, helping with troubleshooting.
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        These settings apply to all provider clients and provide resilience against slow or unresponsive APIs.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Guided Setup Modal Components - Disabled during Admin API migration *@
@* 
<GuidedSetupWizard
    @ref="guidedSetupWizardInstance"
    IsOpen="isGuidedSetupOpen"
    OnSetupComplete="@(async (ConduitLLM.Configuration.Entities.ProviderCredential provider) => await HandleSetupComplete(provider))"
    IsOpenChanged="HandleIsOpenChanged" />
*@

@code {
    // --- Providers and Mappings State ---
    private List<ConfigDTOs.ProviderCredentialDto> providerCredentials = new();
    private List<ConfigDTOs.ModelProviderMappingDto> modelMappings = new();
    private List<ConfigDTOs.GlobalSettingDto> globalSettings = new();

    // Provider form state
    private ConfigDTOs.ProviderCredentialDto currentProvider = new();

    // Mapping form state
    private bool isEditingMapping = false;
    // Create a custom model for the form to include an ID field
    private class MappingFormModel
    {
        public int Id { get; set; } = 0;
        public string ModelAlias { get; set; } = "";
        public string ProviderName { get; set; } = "";
        public string ProviderModelId { get; set; } = "";
    }
    
    private MappingFormModel currentMapping = new() 
    { 
        ModelAlias = "",
        ProviderName = "",
        ProviderModelId = "",
        Id = 0
    };
    private string? mappingErrorMessage;
    private List<string> availableModels = new();
    private bool isLoadingModels = false;
    private bool showModelTextbox = false; // Whether to show textbox instead of dropdown

    // Settings state
    private ConfigDTOs.GlobalSettingDto currentSettings = new();
    
    // HTTP options state
    private string? proxyBaseUrlInput;
    private string? proxyUrlSaveMessage;
    private string? httpRetryOptionsSaveMessage;
    private string? httpTimeoutOptionsSaveMessage;
    private ConduitLLM.Providers.Configuration.RetryOptions httpRetryOptions = new();
    private ConduitLLM.Providers.Configuration.TimeoutOptions httpTimeoutOptions = new();
    
    // --- Guided Setup State (Disabled during Admin API migration) ---
    // private GuidedSetupWizard? guidedSetupWizardInstance;
    // private bool isGuidedSetupOpen;
    private string? deleteErrorMessage;
    
    private readonly List<string> _supportedProviders = new List<string> {
        "OpenAI", "OpenAI Compatible", "Anthropic", "Cohere", "Google", "Mistral", "Groq", "HuggingFace", "AWS", "Azure", "OpenRouter", "Cerebras"
    };
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadProvidersAsync();
            await LoadModelMappingsAsync();
            await LoadProxyUrlAsync();
            await LoadHttpRetryOptionsAsync();
            await LoadHttpTimeoutOptionsAsync();
            
            // Guided setup wizard disabled during Admin API migration
            // await Task.Delay(100); // Brief delay to ensure component rendering completes
            // if (guidedSetupWizardInstance == null)
            // {
            //     Logger.LogWarning("GuidedSetupWizard component reference was null during initialization. UI interactions may not work as expected.");
            // }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing Configuration page");
        }
    }
    
    // --- Settings Loading Methods ---
    
    private async Task LoadProvidersAsync()
    {
        try
        {
            var providers = await AdminApiClient.GetAllProviderCredentialsAsync();
            providerCredentials = providers.ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading provider credentials");
            providerCredentials = new List<ConfigDTOs.ProviderCredentialDto>(); 
        }
    }
    
    private async Task LoadModelMappingsAsync()
    {
        try
        {
            var mappings = await AdminApiClient.GetAllModelProviderMappingsAsync();
            modelMappings = mappings.OrderBy(m => m.ModelId).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading model mappings");
            modelMappings = new List<ConfigDTOs.ModelProviderMappingDto>();
        }
    }
    
    private async Task LoadProxyUrlAsync()
    {
        try
        {
            proxyBaseUrlInput = await AdminApiClient.GetSettingAsync("ConduitSettings:ProxyBaseUrl");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading proxy URL setting");
        }
    }
    
    private async Task LoadHttpRetryOptionsAsync()
    {
        // TODO: Update to use AdminApiClient once HTTP config API is available
        httpRetryOptions = new ConduitLLM.Providers.Configuration.RetryOptions();
        await Task.CompletedTask;
    }
    
    private async Task LoadHttpTimeoutOptionsAsync()
    {
        // TODO: Update to use AdminApiClient once HTTP config API is available
        httpTimeoutOptions = new ConduitLLM.Providers.Configuration.TimeoutOptions();
        await Task.CompletedTask;
    }
    
    // --- Provider/Mapping Methods ---
    
    private void AddProvider()
    {
        NavigationManager.NavigateTo("/configuration/provider/edit");
    }

    private void EditProvider(int id)
    {
        NavigationManager.NavigateTo($"/configuration/provider/edit/{id}");
    }

    private async Task DeleteProvider(int id)
    {
        try
        {
            deleteErrorMessage = null;
            var providerToDelete = await AdminApiClient.GetProviderCredentialByIdAsync(id);
            if (providerToDelete == null) return;

            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
                $"Are you sure you want to delete the provider '{providerToDelete.ProviderName}'? This cannot be undone.");

            if (!confirmed) return;

            // Get related mappings and delete them first
            var allMappings = await AdminApiClient.GetAllModelProviderMappingsAsync();
            var relatedMappings = allMappings.Where(m => int.Parse(m.ProviderId) == providerToDelete.Id).ToList();

            foreach (var mapping in relatedMappings)
            {
                await AdminApiClient.DeleteModelProviderMappingAsync(mapping.Id);
            }

            var success = await AdminApiClient.DeleteProviderCredentialAsync(id);
            
            if (success)
            {
                await LoadProvidersAsync(); 
                await LoadModelMappingsAsync();
                
                deleteErrorMessage = null;
                await JSRuntime.InvokeVoidAsync("alert", $"Provider '{providerToDelete.ProviderName}' deleted successfully");
            }
            else
            {
                deleteErrorMessage = "Failed to delete provider.";
            }
        }
        catch (Exception ex)
        {
            deleteErrorMessage = $"Error deleting provider: {ex.Message}";
            Logger.LogError(ex, "Error deleting provider");
            StateHasChanged();
        }
    }

    private void AddMapping()
    {
        NavigationManager.NavigateTo("/configuration/mapping/edit");
    }

    private void EditMapping(int id)
    {
        NavigationManager.NavigateTo($"/configuration/mapping/edit/{id}");
    }

    private async Task DeleteMapping(int id)
    {
        try
        {
            var mapping = await AdminApiClient.GetModelProviderMappingByIdAsync(id);
            if (mapping == null)
            {
                Logger.LogError("No mapping found with ID {Id}", id);
                return;
            }

            var success = await AdminApiClient.DeleteModelProviderMappingAsync(id);
            
            if (success)
            {
                await LoadModelMappingsAsync();
                await JSRuntime.InvokeVoidAsync("alert", "Model mapping deleted successfully");
            }
            else
            {
                Logger.LogError("Failed to delete mapping with ID {Id}", id);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting mapping");
            deleteErrorMessage = $"Error deleting mapping: {ex.Message}";
            StateHasChanged();
        }
    }

    private void LaunchGuidedSetup(string providerName) 
    {
        try
        {
            Logger.LogDebug("LaunchGuidedSetup called for provider: {ProviderName}", providerName);
            
            // Navigate to the provider edit page
            NavigationManager.NavigateTo("/configuration/provider/edit");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling guided setup for {ProviderName}", providerName);
            deleteErrorMessage = $"Error: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task HandleIsOpenChanged(bool isOpen)
    {
        Logger.LogDebug("HandleIsOpenChanged called with value: {IsOpen}", isOpen);
        // isGuidedSetupOpen = isOpen; // Disabled during Admin API migration
        
        // Force UI update
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task HandleSetupComplete(ConduitLLM.Configuration.Entities.ProviderCredential providerEntity) 
    {
        try
        {
            Logger.LogDebug("HandleSetupComplete called for provider: {ProviderName}", providerEntity.ProviderName);
            
            // Convert entity to DTO
            var newProvider = new ConfigDTOs.CreateProviderCredentialDto
            {
                ProviderName = providerEntity.ProviderName,
                ApiKey = providerEntity.ApiKey,
                ApiBase = providerEntity.BaseUrl,
                IsEnabled = providerEntity.IsEnabled
            };
            
            var createdProvider = await AdminApiClient.CreateProviderCredentialAsync(newProvider);
            
            if (createdProvider != null)
            {
                await LoadProvidersAsync();
                await LoadModelMappingsAsync();
                
                // The wizard should close itself via the IsOpenChanged event
                // We don't need to set isGuidedSetupOpen = false here as it will be set in HandleIsOpenChanged
                
                await JSRuntime.InvokeVoidAsync("alert", $"Provider '{newProvider.ProviderName}' added successfully");
            }
            else
            {
                deleteErrorMessage = "Failed to create provider. It may already exist.";
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving provider from guided setup");
            deleteErrorMessage = $"Error saving provider: {ex.Message}";
            await InvokeAsync(StateHasChanged);
        }
    }

    private string GetProviderDescription(string provider)
    {
        return provider switch
        {
            "OpenAI" => "Connect to GPT-3.5, GPT-4, and other OpenAI models",
            "OpenAI Compatible" => "Connect to any service with an OpenAI-compatible API (Requires Base URL)",
            "Anthropic" => "Connect to Claude models for advanced reasoning",
            "Cohere" => "Connect to Cohere's command models",
            "Google" => "Connect to Google AI models like Gemini",
            "Mistral" => "Connect to Mistral AI's models",
            "Groq" => "Connect to models running on Groq's LPU Inference Engine for high speed",
            "HuggingFace" => "Access models hosted on Hugging Face Inference Endpoints",
            "AWS" => "Connect to models via AWS Bedrock or SageMaker (Requires Base URL)",
            "Azure" => "Connect to models deployed on Azure OpenAI Service (Requires Base URL)",
            "OpenRouter" => "Route requests to various models through OpenRouter",
            "Cerebras" => "Connect to models running on Cerebras infrastructure",
            _ => "Connect to AI models through this provider"
        };
    }
    
    private string GetProviderNameById(string providerId)
    {
        if (string.IsNullOrEmpty(providerId) || !int.TryParse(providerId, out int id))
        {
            return "Unknown";
        }
        
        var provider = providerCredentials.FirstOrDefault(p => p.Id == id);
        return provider?.ProviderName ?? "Unknown";
    }

    // --- Mapping form state ---
    private async Task HandleEditMapping(int id)
    {
        var mapping = await AdminApiClient.GetModelProviderMappingByIdAsync(id);
            
        if (mapping != null)
        {
            // Get provider by ID to get the provider name
            var provider = await AdminApiClient.GetProviderCredentialByIdAsync(int.Parse(mapping.ProviderId));
            
            currentMapping = new MappingFormModel
            {
                Id = mapping.Id, // Store the ID to identify this record for updates
                ModelAlias = mapping.ModelId,
                ProviderName = provider?.ProviderName ?? "",
                ProviderModelId = mapping.ProviderModelId
            };
            isEditingMapping = true;
            mappingErrorMessage = null;
            
            // Load models for the selected provider
            await LoadModelsForSelectedProvider();
        }
    }

    private async Task SaveMapping()
    {
        mappingErrorMessage = null;

        if (string.IsNullOrWhiteSpace(currentMapping.ModelAlias))
        {
            mappingErrorMessage = "Model alias is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(currentMapping.ProviderName))
        {
            mappingErrorMessage = "Provider is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(currentMapping.ProviderModelId))
        {
            mappingErrorMessage = "Provider model is required";
            return;
        }

        // Get provider by name to ensure it exists
        var allProviders = await AdminApiClient.GetAllProviderCredentialsAsync();
        var provider = allProviders.FirstOrDefault(p => p.ProviderName == currentMapping.ProviderName);
            
        if (provider == null)
        {
            mappingErrorMessage = $"Provider {currentMapping.ProviderName} not found. Please add this provider first.";
            return;
        }
        
        // Check for duplicate alias only if we're creating a new mapping or changing the alias
        var allMappings = await AdminApiClient.GetAllModelProviderMappingsAsync();
        var existingMapping = allMappings.FirstOrDefault(m => m.ModelId == currentMapping.ModelAlias && 
                                                              m.Id != currentMapping.Id); // Exclude the current mapping by ID
                                     
        if (existingMapping != null)
        {
            mappingErrorMessage = $"A mapping with alias '{currentMapping.ModelAlias}' already exists";
            return;
        }

        try
        {
            // Determine if this is an update or a new record
            bool isUpdate = currentMapping.Id > 0;
            
            var mappingEntity = new ConduitLLM.Configuration.Entities.ModelProviderMapping
            {
                Id = currentMapping.Id,
                ModelAlias = currentMapping.ModelAlias,
                ProviderModelName = currentMapping.ProviderModelId,
                ProviderCredentialId = provider.Id,
                IsEnabled = true,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };
            
            bool result;
            
            if (isUpdate)
            {
                result = await AdminApiClient.UpdateModelProviderMappingAsync(mappingEntity.Id, mappingEntity);
                
                if (!result)
                {
                    mappingErrorMessage = "The mapping you're trying to update no longer exists.";
                    return;
                }
            }
            else
            {
                result = await AdminApiClient.CreateModelProviderMappingAsync(mappingEntity);
                
                if (!result)
                {
                    mappingErrorMessage = "Failed to create the mapping.";
                    return;
                }
            }
            
            isEditingMapping = false;
            currentMapping = new MappingFormModel 
            { 
                ModelAlias = "",
                ProviderName = "",
                ProviderModelId = "",
                Id = 0
            };
            await LoadModelMappingsAsync();
            mappingErrorMessage = null;
            
            await JSRuntime.InvokeVoidAsync("alert", "Model mapping saved successfully");
        }
        catch (Exception ex)
        {
            mappingErrorMessage = $"Error saving mapping: {ex.Message}";
            Logger.LogError(ex, "Error saving mapping");
        }
    }

    private async Task SaveProxyUrl()
    {
        try
        {
            await AdminApiClient.SetSettingAsync("ConduitSettings:ProxyBaseUrl", proxyBaseUrlInput ?? string.Empty);
            
            proxyUrlSaveMessage = "Base URL saved successfully";
            await JSRuntime.InvokeVoidAsync("alert", "Base URL saved successfully");
            await Task.Delay(3000); 
            proxyUrlSaveMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            proxyUrlSaveMessage = $"Error saving URL: {ex.Message}";
            deleteErrorMessage = $"Error saving URL: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task SaveHttpRetryOptions()
    {
        try
        {
            // TODO: Update to use AdminApiClient once HTTP config API is available
            // await AdminApiClient.UpdateHttpRetryConfigurationAsync(httpRetryOptions);
            httpRetryOptionsSaveMessage = "HTTP retry settings saved successfully.";
            await JSRuntime.InvokeVoidAsync("alert", "HTTP retry settings saved successfully (placeholder)");
        }
        catch (Exception ex)
        {
            httpRetryOptionsSaveMessage = $"Error saving settings: {ex.Message}";
            deleteErrorMessage = $"Error saving settings: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task SaveHttpTimeoutOptions()
    {
        try
        {
            // TODO: Update to use AdminApiClient once HTTP config API is available
            // await AdminApiClient.UpdateHttpTimeoutConfigurationAsync(httpTimeoutOptions);
            httpTimeoutOptionsSaveMessage = "HTTP timeout settings saved successfully.";
            await JSRuntime.InvokeVoidAsync("alert", "HTTP timeout settings saved successfully (placeholder)");
        }
        catch (Exception ex)
        {
            httpTimeoutOptionsSaveMessage = $"Error saving settings: {ex.Message}";
            deleteErrorMessage = $"Error saving settings: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task<bool> CheckIfProviderHasMappings(string providerName)
    {
        try
        {
            // Get the provider ID by name
            var allProviders = await AdminApiClient.GetAllProviderCredentialsAsync();
            var provider = allProviders.FirstOrDefault(p => p.ProviderName == providerName);
            if (provider == null)
                return false;
                
            // Get all mappings and check if any map to this provider
            var allMappings = await AdminApiClient.GetAllModelProviderMappingsAsync();
            return allMappings.Any(m => m.ProviderId == provider.Id.ToString());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking if provider has mappings");
            return false;
        }
    }
    
    private async Task LoadModelsForSelectedProvider()
    {
        if (string.IsNullOrEmpty(currentMapping.ProviderName))
        {
            availableModels.Clear();
            return;
        }

        try
        {
            isLoadingModels = true;
            StateHasChanged();
            
            availableModels = await ProviderModelsService.GetModelsAsync(currentMapping.ProviderName);
            
            // If the previously selected model is not in the list, clear it
            if (!string.IsNullOrEmpty(currentMapping.ProviderModelId) && 
                !availableModels.Contains(currentMapping.ProviderModelId))
            {
                currentMapping.ProviderModelId = "";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading models for provider {ProviderName}", currentMapping.ProviderName);
            availableModels.Clear();
        }
        finally
        {
            isLoadingModels = false;
            StateHasChanged();
        }
    }
    
    private void ToggleModelInputMode()
    {
        // Toggle between dropdown and textbox
        showModelTextbox = !showModelTextbox;
    }
    
    private async Task RefreshModelsList()
    {
        if (string.IsNullOrEmpty(currentMapping.ProviderName))
        {
            return;
        }
        
        try
        {
            isLoadingModels = true;
            StateHasChanged();
            
            // Force refresh from API
            availableModels = await ProviderModelsService.GetModelsAsync(currentMapping.ProviderName, true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing models for provider {ProviderName}", currentMapping.ProviderName);
            availableModels.Clear();
        }
        finally
        {
            isLoadingModels = false;
            StateHasChanged();
        }
    }
}

<style>
    /* Keep only styles specific to this page that aren't covered by components */
    .config-stats .stat-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 0.5rem 1rem;
        display: inline-block;
    }
    
    .provider-card {
        transition: all 0.2s ease;
    }
    
    .provider-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    
    .provider-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .bg-primary-light {
        background-color: rgba(102, 126, 234, 0.1);
    }
    
    .hover-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    
    .hover-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
    }
    
    .table th {
        background-color: #f8f9fa;
    }
</style>