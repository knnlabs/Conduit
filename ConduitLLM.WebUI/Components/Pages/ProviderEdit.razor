@page "/configuration/provider/edit/{id?}"
@using System.Text.Json
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Logging
@using ConduitLLM.Configuration
@using ConduitLLM.Configuration.Entities
@using ConduitLLM.WebUI.Services
@inject IDbContextFactory<ConduitLLM.Configuration.ConfigurationDbContext> DbContextFactory
@inject NavigationManager NavigationManager
@inject ProviderStatusService ProviderStatusService
@inject ConfigurationChangeNotifier ConfigNotifier
@inject ILogger<ProviderEdit> _logger
@rendermode InteractiveServer

<MudText Typo="Typo.h3" Class="mb-4">@(Id.HasValue ? "Edit Provider" : "Add Provider")</MudText>

@if (isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (provider == null)
{
    <MudAlert Severity="Severity.Error">Provider not found or error loading.</MudAlert>
}
else
{
    <EditForm EditContext="editContext" OnValidSubmit="HandleValidSubmit" FormName="ProviderForm"> 
        <DataAnnotationsValidator />
        @* Keep ValidationSummary for other potential errors *@
        <ValidationSummary />

        @* Display general errors above the form *@
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
        }

        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Elevation="2" Class="pa-4 mb-4">
                    <MudSelect T="string" 
                              Label="Provider Name"
                              @bind-Value="provider.ProviderName"
                              Disabled="@Id.HasValue" 
                              Variant="Variant.Outlined"
                              Class="mb-4"
                              For="@(() => provider.ProviderName)">
                        <MudSelectItem Value="@("")">-- Select Provider --</MudSelectItem>
                        @foreach (var name in _supportedProviders)
                        {
                            <MudSelectItem Value="@name">@name</MudSelectItem>
                        }
                    </MudSelect>
                    @if (Id.HasValue)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">Provider name cannot be changed after creation.</MudText>
                    }

                    @* Conditionally hide BaseUrl for OpenRouter *@
                    @if (provider.ProviderName != "OpenRouter")
                    {
                        <MudTextField 
                            T="string" 
                            @bind-Value="provider.BaseUrl" 
                            Label="API Base URL (Optional, leave empty for default)" 
                            Placeholder="https://api.example.com" 
                            Variant="Variant.Outlined"
                            For="@(() => provider.BaseUrl)"
                            Class="mb-4" />
                    }

                    <MudTextField 
                        T="string" 
                        @bind-Value="provider.ApiVersion" 
                        Label="API Version (Optional)" 
                        Placeholder="v1" 
                        Variant="Variant.Outlined"
                        For="@(() => provider.ApiVersion)"
                        Class="mb-4" />

                    <MudTextField 
                        T="string" 
                        @bind-Value="provider.ApiKey" 
                        Label="API Key" 
                        InputType="InputType.Password"
                        Placeholder="@(originalApiKey?.Length > 0 ? "••••••••" : "sk-...")"
                        Variant="Variant.Outlined"
                        For="@(() => provider.ApiKey)"
                        HelperText="Existing keys are not displayed for security reasons. Leave empty to keep the current key."
                        Class="mb-4" />
                
                    @if (!string.IsNullOrEmpty(provider.ProviderName) && 
                          (ProviderApiInfo.GetApiKeyUrl(provider.ProviderName) != null || 
                           ProviderApiInfo.GetDocumentationUrl(provider.ProviderName) != null))
                    {
                        <MudPaper Elevation="0" Class="pa-4 mb-4 mud-background-gray">
                            <MudText Typo="Typo.h6" Class="mb-3">@provider.ProviderName Resources</MudText>
                            <MudStack>
                                @if (ProviderApiInfo.GetApiKeyUrl(provider.ProviderName) != null)
                                {
                                    <MudLink Href="@ProviderApiInfo.GetApiKeyUrl(provider.ProviderName)" Target="_blank" Class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Key" Class="mr-2" Size="Size.Small" />
                                        Get API Key
                                    </MudLink>
                                }
                                @if (ProviderApiInfo.GetDocumentationUrl(provider.ProviderName) != null)
                                {
                                    <MudLink Href="@ProviderApiInfo.GetDocumentationUrl(provider.ProviderName)" Target="_blank" Class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.MenuBook" Class="mr-2" Size="Size.Small" />
                                        View Documentation
                                    </MudLink>
                                }
                            </MudStack>
                        </MudPaper>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                @if (!string.IsNullOrEmpty(provider.ProviderName) && !string.IsNullOrEmpty(provider.ApiKey))
                {
                    <MudPaper Elevation="2" Class="pa-4 mb-4">
                        <MudText Typo="Typo.h6" Class="mb-4">Connection Test</MudText>
                        
                        @if (showConnectionStatus)
                        {
                            <MudAlert Severity="@(connectionStatus?.IsOnline ?? false ? Severity.Success : Severity.Error)" 
                                    Class="mb-3" 
                                    Icon="@(connectionStatus?.IsOnline ?? false ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)">
                                @if (connectionStatus?.IsOnline ?? false)
                                {
                                    <MudText Typo="Typo.body1"><strong>Connected successfully!</strong></MudText>
                                }
                                else
                                {
                                    <div>
                                        <MudText Typo="Typo.body1"><strong>Connection failed</strong></MudText>
                                        <MudText Typo="Typo.body2" Class="mt-2">@connectionStatusMessage</MudText>
                                    </div>
                                }
                            </MudAlert>
                            
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">
                                Last tested: @(connectionStatus != null ? connectionStatus.LastCheckedUtc.ToLocalTime().ToString("g") : "")
                            </MudText>
                        }
                        
                        <MudButton 
                            Variant="Variant.Outlined" 
                            Color="Color.Primary" 
                            OnClick="TestConnection" 
                            Disabled="@isTestingConnection"
                            StartIcon="@(isTestingConnection ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Bolt)"
                            Class="mb-2">
                            @if (isTestingConnection)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Testing...</span>
                            }
                            else
                            {
                                <span>Test Connection</span>
                            }
                        </MudButton>
                        
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Verifies your API key and connection settings
                        </MudText>
                    </MudPaper>
                }
            </MudItem>
        </MudGrid>

        <MudPaper Elevation="0" Class="d-flex gap-2 mt-6">
            <MudButton 
                ButtonType="ButtonType.Submit" 
                Variant="Variant.Filled" 
                Color="Color.Primary" 
                Disabled="@isSaving"
                StartIcon="@Icons.Material.Filled.Save">
                @if (isSaving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save Provider</span>
                }
            </MudButton>
            
            <MudButton 
                Variant="Variant.Outlined" 
                Color="Color.Secondary" 
                OnClick="Cancel" 
                Disabled="@isSaving">
                Cancel
            </MudButton>
            
            <MudButton 
                Variant="Variant.Outlined" 
                Color="Color.Primary" 
                OnClick="TestConnection" 
                Disabled="@(isTestingConnection || isSaving)"
                StartIcon="@Icons.Material.Filled.Bolt">
                @if (isTestingConnection)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Testing...</span>
                }
                else
                {
                    <span>Test Connection</span>
                }
            </MudButton>
        </MudPaper>
    </EditForm>
}

@code {
    [Parameter]
    public int? Id { get; set; }

    private ConduitLLM.Configuration.Entities.ProviderCredential provider = new ConduitLLM.Configuration.Entities.ProviderCredential { ProviderName = "" }; // Use correct entity type
    private string? errorMessage;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isTestingConnection = false;
    private ProviderStatus? connectionStatus = null;
    private string connectionStatusMessage = "";
    private bool showConnectionStatus = false;
    private string? originalApiKey;
    private EditContext editContext = null!;
    private readonly string[] _supportedProviders = { "OpenAI", "Anthropic", "Cohere", "Gemini", "Fireworks", "OpenRouter", "Cerebras", "AWS Bedrock", "SageMaker", "VertexAI", "HuggingFace", "Groq", "Mistral" };

    protected override async Task OnInitializedAsync()
    {
        editContext = new EditContext(provider);
        
        if (Id.HasValue)
        {
            isLoading = true;
            StateHasChanged();
            
            try
            {
                // Use Config context for ProviderCredentials
                using var dbContext = await DbContextFactory.CreateDbContextAsync(); 
                var existingProvider = await dbContext.ProviderCredentials.FindAsync(Id.Value);
                
                if (existingProvider != null)
                {
                    // Directly use the loaded entity from Config context
                    provider = existingProvider; 
                    
                    // Keep track of the original API key existence
                    if (!string.IsNullOrEmpty(existingProvider.ApiKey))
                    {
                        originalApiKey = "PLACEHOLDER"; // Just indicate it exists
                    }
                }
                else
                {
                    NavigationManager.NavigateTo("/configuration");
                    return;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading provider: {ex.Message}");
                errorMessage = $"Error loading provider: {ex.Message}";
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        }
        else
        {
            // Initialize a new Configuration entity for adding
            provider = new ConduitLLM.Configuration.Entities.ProviderCredential { ProviderName = "" }; 
            isLoading = false;
        }
        
        editContext = new EditContext(provider);
    }

    private async Task HandleValidSubmit()
    {
        isSaving = true;
        errorMessage = null;
        StateHasChanged();
        
            try 
            {
                // Use Config context for ProviderCredentials
                await using var dbContext = await DbContextFactory.CreateDbContextAsync(); 
                
                if (Id.HasValue) // Edit
                {
                var existingProvider = await dbContext.ProviderCredentials.FindAsync(Id.Value);
                
                if (existingProvider != null)
                {
                    // Update the entity with form values
                    existingProvider.BaseUrl = string.IsNullOrWhiteSpace(provider.BaseUrl) ? null : provider.BaseUrl; // Use BaseUrl
                    existingProvider.ApiVersion = string.IsNullOrWhiteSpace(provider.ApiVersion) ? null : provider.ApiVersion;
                    // Name doesn't exist
                    
                    // Only update API key if provided (not empty)
                    if (!string.IsNullOrWhiteSpace(provider.ApiKey))
                    {
                        existingProvider.ApiKey = provider.ApiKey;
                    }
                    // The logic for handling existing API key needs adjustment as we're now using the Config context entity
                    // If provider.ApiKey is blank, we want to keep the existing key from the database.
                    // If originalApiKey was null (meaning no key existed before), and provider.ApiKey is blank, set it to null.
                    else if (string.IsNullOrWhiteSpace(provider.ApiKey)) 
                    {
                        if (originalApiKey != null) // A key existed before, keep it
                        {
                            // Re-fetch the existing key from the database to avoid overwriting it with null
                            var freshProvider = await dbContext.ProviderCredentials.AsNoTracking().FirstOrDefaultAsync(p => p.Id == Id.Value);
                            existingProvider.ApiKey = freshProvider?.ApiKey;
                        }
                        else // No original key, and input is blank, so set to null
                        {
                            existingProvider.ApiKey = null;
                        }
                    }
                    // If provider.ApiKey has a value, it was already assigned above.

                    // Removed incorrect null assignment here

                    dbContext.ProviderCredentials.Update(existingProvider); 
                }
                else
                {
                     // Handle case where provider was deleted between load and save
                     Console.WriteLine("Error: Provider not found during update.");
                     errorMessage = "Error: Provider not found during update.";
                     StateHasChanged();
                     return;
                }
            }
            else // Add
            {
                 // The 'provider' object is already the correct type (ConduitLLM.Configuration.Entities.ProviderCredential)
                 // Ensure optional fields are null if empty/whitespace
                 provider.BaseUrl = string.IsNullOrWhiteSpace(provider.BaseUrl) ? null : provider.BaseUrl; // Use BaseUrl
                 provider.ApiVersion = string.IsNullOrWhiteSpace(provider.ApiVersion) ? null : provider.ApiVersion;
                 provider.ApiKey = string.IsNullOrWhiteSpace(provider.ApiKey) ? null : provider.ApiKey;
                 // Name doesn't exist
                 // Set default values for non-nullable properties if needed (assuming they are not set by default in the entity)
                 provider.IsEnabled = true; 
                 provider.CreatedAt = DateTime.UtcNow;
                 provider.UpdatedAt = DateTime.UtcNow;

                await dbContext.ProviderCredentials.AddAsync(provider); // Add the provider object directly
            }
            
            await dbContext.SaveChangesAsync();
            
            // Notify the Conduit HTTP proxy about configuration changes
            try
            {
                // Get the proxy base URL from global settings (using Config context)
                await using var configContext = await DbContextFactory.CreateDbContextAsync(); 
                var proxyUrlSetting = await configContext.GlobalSettings
                    .FirstOrDefaultAsync(s => s.Key == "ProxyBaseUrl");
                
                string proxyUrl = proxyUrlSetting?.Value ?? "http://localhost:5000";
                
                bool notificationSuccess = await ConfigNotifier.NotifyConfigurationChangedAsync(proxyUrl);
                if (!notificationSuccess)
                {
                    _logger.LogWarning("Failed to notify proxy server about configuration changes. The server may need to be restarted.");
                    // We still proceed with navigation even if notification fails
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error notifying proxy server about configuration changes");
                // We still proceed with navigation even if notification fails
            }
            
            NavigationManager.NavigateTo("/configuration"); // Redirect back to the list
        }
        catch (DbUpdateException dbEx)
        {
             // Handle potential database errors (like unique constraint violation if check failed)
             Console.WriteLine($"Database error saving provider: {dbEx.InnerException?.Message ?? dbEx.Message}");
             errorMessage = $"Database error saving provider: {dbEx.InnerException?.Message ?? dbEx.Message}";
        }
        catch (Exception ex)
        {
             Console.WriteLine($"Error saving provider: {ex.Message}");
             errorMessage = $"Error saving provider: {ex.Message}";
        }
        finally
        {
            isSaving = false; // Reset saving flag
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/configuration");
    }

    private async Task TestConnection()
    {
        if (string.IsNullOrWhiteSpace(provider.ApiKey))
        {
            showConnectionStatus = true;
            connectionStatusMessage = "API key is required to test the connection";
            connectionStatus = null;
            return;
        }

        isTestingConnection = true;
        showConnectionStatus = false;
        connectionStatus = null;
        StateHasChanged();

        try
        {
            // Use the correct properties for testing
            var testProvider = new ConduitLLM.Configuration.Entities.ProviderCredential 
            {
                ProviderName = provider.ProviderName,
                ApiKey = provider.ApiKey,
                BaseUrl = provider.BaseUrl, // Use BaseUrl
                ApiVersion = provider.ApiVersion
                // Name doesn't exist
            };
            // Assuming ProviderConnectionTester can handle the Configuration entity type
            connectionStatus = await ProviderConnectionTester.TestConnectionAsync(ProviderStatusService, testProvider); 
            showConnectionStatus = true;
            if (connectionStatus.IsOnline)
            {
                connectionStatusMessage = "Connection successful! API key is valid and the service is reachable.";
            }
            else
            {
                connectionStatusMessage = $"Connection failed: {connectionStatus.StatusMessage}";
            }
        }
        finally
        {
            isTestingConnection = false;
            StateHasChanged();
        }
    }

    private void EditProvider(int id)
    {
        NavigationManager.NavigateTo($"/configuration/provider/edit/{id}");
    }

    private string GetProviderDescription(string providerName)
    {
        return providerName switch
        {
            "OpenAI" => "Provides access to GPT models from OpenAI.",
            "Anthropic" => "Provides access to Claude models from Anthropic.",
            "Cohere" => "Provides access to language models from Cohere.",
            "Gemini" => "Provides access to Gemini models from Google.",
            "Fireworks" => "Provides access to a variety of open-source and first-party models.",
            "OpenRouter" => "Provides unified API access to many LLM providers.",
            "Cerebras" => "Provides access to Cerebras Slimpajama models.",
            "AWS Bedrock" => "Provides access to foundation models via Amazon Bedrock.",
            "SageMaker" => "Provides access to hosted LLMs via AWS SageMaker.",
            "VertexAI" => "Provides access to Google Vertex AI models.",
            "HuggingFace" => "Provides access to HuggingFace Hub models.",
            "Groq" => "Provides ultra-fast inference via Groq.",
            "Mistral" => "Provides access to Mistral AI models.",
            _ => "Provides access to language models."
        };
    }
}
