@using Microsoft.JSInterop
@using ConduitLLM.WebUI.DTOs
@using ConduitLLM.WebUI.Models
@using ConduitLLM.WebUI.Services
@using System.Text.Json
@implements IAsyncDisposable
@inject IJSRuntime JS
@inject ILogger<AdminNotificationListener> Logger
@inject NotificationService NotificationService

@code {
    /// <summary>
    /// Virtual key for authentication (legacy - for backward compatibility)
    /// </summary>
    [Parameter] public string? VirtualKey { get; set; }
    
    /// <summary>
    /// Master key for authentication (preferred for admin notifications)
    /// </summary>
    [Parameter] public string? MasterKey { get; set; }
    
    /// <summary>
    /// Auto-connect on initialization
    /// </summary>
    [Parameter] public bool AutoConnect { get; set; } = true;
    
    /// <summary>
    /// Enable debug mode for detailed logging
    /// </summary>
    [Parameter] public bool DebugMode { get; set; } = false;

    private IJSObjectReference? _signalRService;
    private IJSObjectReference? _navigationHub;
    private DotNetObjectReference<AdminNotificationListener>? _dotNetRef;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Create reference to this component for JS callbacks
            _dotNetRef = DotNetObjectReference.Create(this);
            
            // Get SignalR service instance
            _signalRService = await JS.InvokeAsync<IJSObjectReference>("ConduitSignalRService.getInstance");
            
            // Set debug mode if enabled
            if (DebugMode)
            {
                await _signalRService.InvokeVoidAsync("setDebugMode", true);
            }
            
            // Determine which key to use (prefer MasterKey over VirtualKey)
            var authKey = !string.IsNullOrEmpty(MasterKey) ? MasterKey : VirtualKey;
            var isMasterKey = !string.IsNullOrEmpty(MasterKey);
            
            if (string.IsNullOrEmpty(authKey))
            {
                Logger.LogWarning("No authentication key provided for AdminNotificationListener");
                return;
            }
            
            // Set authentication key
            if (isMasterKey)
            {
                await _signalRService.InvokeVoidAsync("setMasterKey", authKey);
                Logger.LogInformation("Using master key authentication for admin notifications");
            }
            else
            {
                await _signalRService.InvokeVoidAsync("setVirtualKey", authKey);
                Logger.LogInformation("Using virtual key authentication for admin notifications (legacy)");
            }
            
            // Create appropriate hub proxy based on authentication type
            if (isMasterKey)
            {
                _navigationHub = await JS.InvokeAsync<IJSObjectReference>("conduitHubs.createAdminNotificationHub");
            }
            else
            {
                _navigationHub = await JS.InvokeAsync<IJSObjectReference>("conduitHubs.createSystemNotificationHub");
            }
            
            if (AutoConnect)
            {
                await ConnectAsync(authKey, isMasterKey);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize AdminNotificationListener");
        }
    }
    
    /// <summary>
    /// Connect to the appropriate notification hub for admin notifications
    /// </summary>
    public async Task ConnectAsync(string? authKey = null, bool? isMasterKey = null)
    {
        try
        {
            // Use provided parameters or determine from component state
            if (authKey == null)
            {
                authKey = !string.IsNullOrEmpty(MasterKey) ? MasterKey : VirtualKey;
                isMasterKey = !string.IsNullOrEmpty(MasterKey);
            }
            
            if (string.IsNullOrEmpty(authKey))
            {
                Logger.LogWarning("Cannot connect without authentication key");
                return;
            }
            
            // Connect to hub with appropriate authentication
            await _navigationHub!.InvokeVoidAsync("connect", authKey);
            
            // Register event handlers
            await _navigationHub.InvokeVoidAsync("onProviderHealthChanged", _dotNetRef);
            await _navigationHub.InvokeVoidAsync("onModelCapabilitiesDiscovered", _dotNetRef);
            await _navigationHub.InvokeVoidAsync("onModelMappingChanged", _dotNetRef);
            await _navigationHub.InvokeVoidAsync("onSystemAnnouncement", _dotNetRef);
            
            // Additional handlers for master key authenticated hub
            if (isMasterKey == true)
            {
                await _navigationHub.InvokeVoidAsync("onVirtualKeyUpdate", _dotNetRef);
                await _navigationHub.InvokeVoidAsync("onHighSpendAlert", _dotNetRef);
                await _navigationHub.InvokeVoidAsync("onSecurityAlert", _dotNetRef);
            }
            
            Logger.LogInformation("Connected to {HubType} notification hub", 
                isMasterKey == true ? "admin" : "system");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to connect to notification hub");
        }
    }
    
    /// <summary>
    /// Called by JavaScript when provider health changes
    /// </summary>
    [JSInvokable]
    public async Task HandleProviderHealthChanged(JsonElement healthData)
    {
        try
        {
            var providerName = healthData.GetProperty("providerName").GetString() ?? "Unknown";
            var status = healthData.GetProperty("status").GetString() ?? "Unknown";
            var previousStatus = healthData.GetProperty("previousStatus").GetString();
            var responseTime = healthData.GetProperty("responseTimeMs").GetInt32();
            
            var notificationType = status switch
            {
                "Healthy" => NotificationType.Success,
                "Degraded" => NotificationType.BudgetWarning,
                "Unhealthy" => NotificationType.Error,
                _ => NotificationType.System
            };
            
            var statusChange = !string.IsNullOrEmpty(previousStatus) && previousStatus != status
                ? $" (was {previousStatus})"
                : "";
            
            NotificationService.AddNotification(
                notificationType,
                $"Provider {providerName} is now {status}{statusChange}",
                "Provider Health Monitor",
                $"Response time: {responseTime}ms"
            );
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling provider health change notification");
        }
    }
    
    /// <summary>
    /// Called by JavaScript when new models are discovered
    /// </summary>
    [JSInvokable]
    public async Task HandleModelDiscovered(JsonElement modelData)
    {
        try
        {
            var providerName = modelData.GetProperty("providerName").GetString() ?? "Unknown";
            var modelCount = modelData.GetProperty("modelCount").GetInt32();
            var models = new List<string>();
            
            if (modelData.TryGetProperty("models", out var modelsArray))
            {
                foreach (var model in modelsArray.EnumerateArray())
                {
                    if (model.TryGetProperty("id", out var modelId))
                    {
                        models.Add(modelId.GetString() ?? "");
                    }
                }
            }
            
            var modelList = models.Take(3).Any() 
                ? $"Models: {string.Join(", ", models.Take(3))}{(models.Count > 3 ? $" and {models.Count - 3} more" : "")}"
                : "No model details available";
            
            NotificationService.AddNotification(
                NotificationType.System,
                $"Discovered {modelCount} models for provider {providerName}",
                "Model Discovery",
                modelList
            );
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling model discovery notification");
        }
    }
    
    /// <summary>
    /// Called by JavaScript when configuration changes
    /// </summary>
    [JSInvokable]
    public async Task HandleConfigurationChanged(JsonElement configData)
    {
        try
        {
            var changeType = configData.GetProperty("changeType").GetString() ?? "Unknown";
            var entityType = configData.GetProperty("entityType").GetString() ?? "Unknown";
            var entityName = configData.GetProperty("entityName").GetString() ?? "Unknown";
            
            var action = changeType switch
            {
                "Created" => "created",
                "Updated" => "updated",
                "Deleted" => "deleted",
                _ => "changed"
            };
            
            var details = "";
            if (configData.TryGetProperty("changes", out var changes))
            {
                var changeList = new List<string>();
                foreach (var change in changes.EnumerateArray())
                {
                    changeList.Add(change.GetString() ?? "");
                }
                if (changeList.Any())
                {
                    details = $"Changes: {string.Join(", ", changeList)}";
                }
            }
            
            NotificationService.AddNotification(
                NotificationType.System,
                $"{entityType} '{entityName}' was {action}",
                "Configuration Change",
                details
            );
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling configuration change notification");
        }
    }
    
    /// <summary>
    /// Called by JavaScript when system alerts are received
    /// </summary>
    [JSInvokable]
    public async Task HandleSystemAlert(JsonElement alertData)
    {
        try
        {
            var alertType = alertData.GetProperty("alertType").GetString() ?? "Unknown";
            var message = alertData.GetProperty("message").GetString() ?? "System alert";
            var severity = alertData.GetProperty("severity").GetString() ?? "info";
            
            var notificationType = severity switch
            {
                "error" => NotificationType.Error,
                "warning" => NotificationType.BudgetWarning,
                "info" => NotificationType.System,
                _ => NotificationType.System
            };
            
            var details = "";
            if (alertData.TryGetProperty("details", out var detailsElement))
            {
                details = detailsElement.GetString() ?? "";
            }
            
            NotificationService.AddNotification(
                notificationType,
                message,
                $"System Alert: {alertType}",
                details
            );
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling system alert notification");
        }
    }
    
    /// <summary>
    /// Called by JavaScript when virtual key is updated (admin hub only)
    /// </summary>
    [JSInvokable]
    public async Task HandleVirtualKeyUpdate(JsonElement updateData)
    {
        try
        {
            var virtualKeyId = updateData.GetProperty("virtualKeyId").GetInt32();
            var updateType = updateData.GetProperty("updateType").GetString() ?? "unknown";
            var keyName = string.Empty;
            
            if (updateData.TryGetProperty("details", out var details) && 
                details.TryGetProperty("keyName", out var keyNameElement))
            {
                keyName = keyNameElement.GetString() ?? $"Key #{virtualKeyId}";
            }
            else
            {
                keyName = $"Virtual Key #{virtualKeyId}";
            }
            
            var notificationType = updateType switch
            {
                "created" => NotificationType.Success,
                "deleted" => NotificationType.Error,
                "updated" => NotificationType.System,
                _ => NotificationType.System
            };
            
            var message = updateType switch
            {
                "created" => $"Virtual key '{keyName}' was created",
                "deleted" => $"Virtual key '{keyName}' was deleted",
                "updated" => $"Virtual key '{keyName}' was updated",
                _ => $"Virtual key '{keyName}' changed"
            };
            
            NotificationService.AddNotification(
                notificationType,
                message,
                "Virtual Key Management",
                $"Key ID: {virtualKeyId}"
            );
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling virtual key update notification");
        }
    }
    
    /// <summary>
    /// Called by JavaScript when high spend alert is triggered (admin hub only)
    /// </summary>
    [JSInvokable]
    public async Task HandleHighSpendAlert(JsonElement alertData)
    {
        try
        {
            var alertType = alertData.GetProperty("alertType").GetString() ?? "HighSpend";
            var message = alertData.GetProperty("message").GetString() ?? "High spend detected";
            var currentSpend = alertData.GetProperty("currentSpend").GetDecimal();
            var budgetLimit = alertData.GetProperty("budgetLimit").GetDecimal();
            var percentageUsed = alertData.GetProperty("percentageUsed").GetDouble();
            
            var severity = alertData.GetProperty("severity").GetString() ?? "warning";
            var notificationType = severity == "critical" ? NotificationType.Error : NotificationType.BudgetWarning;
            
            var details = $"Current: ${currentSpend:F2} / Budget: ${budgetLimit:F2} ({percentageUsed:F1}% used)";
            
            NotificationService.AddNotification(
                notificationType,
                message,
                $"Spend Alert: {alertType}",
                details
            );
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling high spend alert notification");
        }
    }
    
    /// <summary>
    /// Called by JavaScript when security alert is triggered (admin hub only)
    /// </summary>
    [JSInvokable]
    public async Task HandleSecurityAlert(JsonElement alertData)
    {
        try
        {
            var alertType = alertData.GetProperty("alertType").GetString() ?? "Security";
            var description = alertData.GetProperty("description").GetString() ?? "Security event detected";
            var affectedResource = alertData.TryGetProperty("affectedResource", out var resource) 
                ? resource.GetString() 
                : null;
            
            var details = !string.IsNullOrEmpty(affectedResource) 
                ? $"Affected resource: {affectedResource}" 
                : "";
            
            NotificationService.AddNotification(
                NotificationType.Error,
                description,
                $"Security Alert: {alertType}",
                details
            );
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling security alert notification");
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_navigationHub != null)
            {
                await _navigationHub.InvokeVoidAsync("disconnect");
                await _navigationHub.DisposeAsync();
            }
            
            if (_signalRService != null)
            {
                await _signalRService.DisposeAsync();
            }
            
            _dotNetRef?.Dispose();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error disposing AdminNotificationListener");
        }
    }
}