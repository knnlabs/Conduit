@using Microsoft.AspNetCore.Components
@using ConduitLLM.WebUI.Interfaces
@using ConduitLLM.WebUI.Models
@using System.Threading
@implements IDisposable
@rendermode InteractiveServer

@inject IAdminApiHealthService HealthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="admin-api-status" @onkeydown="HandleKeyDown">
    <Hovercard Position="bottom-end" Delay="200" @ref="hovercardRef">
        <ChildContent>
            @if (HealthService.IsHealthy)
            {
                <button class="status-indicator healthy" aria-label="System Health Status - Healthy" title="System Health - Click for details">
                    <i class="fa fa-heart-pulse"></i>
                </button>
            }
            else
            {
                <button class="status-indicator unhealthy" aria-label="System Health Status - Unhealthy" title="System Health - Issues Detected">
                    <i class="fa fa-heart-crack"></i>
                </button>
            }
        </ChildContent>
        <HovercardContent>
            <div class="health-status-card">
                <div class="status-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            @if (HealthService.IsHealthy)
                            {
                                <i class="fa fa-check-circle text-success me-2"></i>
                                <span class="status-text text-success">Healthy</span>
                            }
                            else
                            {
                                <i class="fa fa-triangle-exclamation text-danger me-2"></i>
                                <span class="status-text text-danger">Unhealthy</span>
                            }
                        </div>
                        <button class="btn btn-sm btn-outline-primary ms-2" @onclick="CheckHealthNow">
                            <i class="fa fa-arrow-rotate-right"></i> Refresh
                        </button>
                    </div>
                </div>

                @if (!HealthService.IsHealthy && !string.IsNullOrEmpty(HealthService.LastErrorMessage))
                {
                    <div class="alert alert-danger alert-sm mt-3 mb-0">
                        <i class="fa fa-circle-exclamation me-1"></i>
                        @HealthService.LastErrorMessage
                    </div>
                }

                @{
                    var details = HealthService.GetConnectionDetails();
                    var detailedStatus = HealthService.LastDetailedStatus;
                }

                <div class="info-section">
                    <h6 class="section-title">Connection Details</h6>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Admin API</span>
                            <span class="info-value">@(details.UseAdminApi ? "Enabled" : "Disabled")</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Base URL</span>
                            <span class="info-value text-truncate" title="@details.BaseUrl">@details.BaseUrl</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Last Check</span>
                            <span class="info-value">@FormatLastChecked()</span>
                        </div>
                    </div>
                </div>

                @if (detailedStatus != null && detailedStatus.Checks.Any())
                {
                    <div class="health-checks-section">
                        <h6 class="section-title">Health Checks</h6>
                        <div class="health-check-list">
                            @foreach (var check in detailedStatus.Checks)
                            {
                                <div class="health-check-item">
                                    <div class="check-header">
                                        <span class="check-name">@FormatCheckName(check.Name)</span>
                                        <span class="check-status @GetStatusClass(check.Status)">
                                            @check.Status
                                        </span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(check.Description))
                                    {
                                        <div class="check-description">@check.Description</div>
                                    }
                                    @if (!string.IsNullOrEmpty(check.Exception))
                                    {
                                        <div class="check-error">
                                            <i class="fa fa-circle-exclamation"></i> @check.Exception
                                        </div>
                                    }
                                    @if (check.Name == "providers" && check.Data != null)
                                    {
                                        <div class="provider-details">
                                            @foreach (var kvp in check.Data.Where(d => d.Key.EndsWith("_status")))
                                            {
                                                var providerName = kvp.Key.Replace("_status", "");
                                                var status = kvp.Value.ToString();
                                                <div class="provider-item">
                                                    <span class="provider-name">@providerName</span>
                                                    <span class="provider-status @GetProviderStatusClass(status)">
                                                        @status
                                                    </span>
                                                </div>
                                            }
                                        </div>
                                    }
                                    <div class="check-duration">@check.Duration.ToString("F1")ms</div>
                                </div>
                            }
                        </div>
                        <div class="total-duration">
                            Total check time: <strong>@detailedStatus.TotalDuration.ToString("F1")ms</strong>
                        </div>
                    </div>
                }

                <div class="action-links">
                    <a href="/provider-health" class="action-link">
                        <i class="fa fa-heart-pulse"></i> Provider Health
                    </a>
                    <a href="/logs" class="action-link">
                        <i class="fa fa-file-lines"></i> View Logs
                    </a>
                    <a href="/configuration" class="action-link">
                        <i class="fa fa-gear"></i> Configuration
                    </a>
                </div>
            </div>
        </HovercardContent>
    </Hovercard>
</div>

@code {
    private Timer? _refreshTimer;
    private Hovercard? hovercardRef;

    protected override void OnInitialized()
    {
        // Start a timer to periodically check health
        _refreshTimer = new Timer(async _ =>
        {
            await HealthService.CheckHealthAsync();
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromMinutes(1));
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }

    private async Task CheckHealthNow()
    {
        await HealthService.GetDetailedHealthAsync(force: true);
        StateHasChanged();
    }

    private string FormatLastChecked()
    {
        if (HealthService.LastChecked == DateTime.MinValue)
        {
            return "Never";
        }

        var elapsed = DateTime.UtcNow - HealthService.LastChecked;
        if (elapsed.TotalSeconds < 60)
        {
            return "Just now";
        }
        else if (elapsed.TotalMinutes < 60)
        {
            return $"{(int)elapsed.TotalMinutes}m ago";
        }
        else
        {
            return HealthService.LastChecked.ToString("HH:mm:ss");
        }
    }

    private string FormatCheckName(string name)
    {
        return name switch
        {
            "database" => "Database",
            "redis" => "Redis Cache",
            "providers" => "LLM Providers",
            _ => name
        };
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "healthy" => "badge bg-success",
            "degraded" => "badge bg-warning",
            "unhealthy" => "badge bg-danger",
            _ => "badge bg-secondary"
        };
    }

    private string GetProviderStatusClass(string? status)
    {
        return status?.ToLower() switch
        {
            "online" => "text-success",
            "offline" => "text-danger",
            "unknown" => "text-warning",
            _ => "text-secondary"
        };
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        // The hovercard component handles keyboard navigation
        // This is just for potential future enhancements
    }
}

<style>
    .admin-api-status {
        position: relative;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        padding: 0;
        outline: none;
        position: relative;
    }

    .status-indicator:hover {
        transform: scale(1.1);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .status-indicator:focus {
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }

    .status-indicator i {
        font-size: 1.25rem;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .healthy {
        color: #52c41a;
        background: rgba(82, 196, 26, 0.1);
        border-color: rgba(82, 196, 26, 0.3);
    }

    .healthy:hover {
        background: rgba(82, 196, 26, 0.2);
        border-color: rgba(82, 196, 26, 0.4);
    }

    .unhealthy {
        color: #ff4d4f;
        background: rgba(255, 77, 79, 0.1);
        border-color: rgba(255, 77, 79, 0.3);
        animation: pulse 2s infinite;
    }

    .unhealthy:hover {
        background: rgba(255, 77, 79, 0.2);
        border-color: rgba(255, 77, 79, 0.4);
    }

    @@keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }

    .health-status-card {
        min-width: 380px;
        padding: 0;
    }

    .status-header {
        padding: 0 0 1rem 0;
        border-bottom: 1px solid var(--bs-border-color);
        margin-bottom: 1.5rem;
    }

    .status-text {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .alert-sm {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        margin-bottom: 0;
    }

    .info-section, .health-checks-section {
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--bs-secondary, #6c757d);
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    [data-bs-theme="dark"] .section-title {
        color: var(--bs-secondary, #adb5bd);
    }

    .info-grid {
        display: grid;
        gap: 0.75rem;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0;
    }

    .info-label {
        font-size: 0.875rem;
        color: var(--bs-secondary, #6c757d);
    }

    .info-value {
        font-size: 0.875rem;
        font-weight: 500;
        max-width: 200px;
        color: var(--bs-body-color, #212529);
    }

    [data-bs-theme="dark"] .info-label {
        color: var(--bs-secondary, #adb5bd);
    }

    [data-bs-theme="dark"] .info-value {
        color: var(--bs-body-color, #dee2e6);
    }

    .health-check-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .health-check-item {
        padding: 1rem;
        background: var(--bs-gray-100);
        border-radius: 0.5rem;
        position: relative;
    }

    [data-bs-theme="dark"] .health-check-item {
        background: var(--bs-gray-800);
    }

    .check-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .check-name {
        font-weight: 500;
        font-size: 0.9rem;
        color: var(--bs-body-color, #212529);
    }

    [data-bs-theme="dark"] .check-name {
        color: var(--bs-body-color, #dee2e6);
    }

    .check-status {
        font-size: 0.75rem;
    }

    .check-description {
        font-size: 0.8rem;
        color: var(--bs-secondary, #6c757d);
        margin-top: 0.5rem;
    }

    [data-bs-theme="dark"] .check-description {
        color: var(--bs-secondary, #adb5bd);
    }

    .check-error {
        font-size: 0.8rem;
        color: var(--bs-danger);
        margin-top: 0.5rem;
    }

    .check-duration {
        position: absolute;
        bottom: 0.5rem;
        right: 0.75rem;
        font-size: 0.7rem;
        color: var(--bs-secondary, #6c757d);
    }

    [data-bs-theme="dark"] .check-duration {
        color: var(--bs-secondary, #adb5bd);
    }

    .provider-details {
        margin-top: 0.75rem;
        padding-left: 1rem;
    }

    .provider-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0;
        font-size: 0.8rem;
    }

    .provider-name {
        color: var(--bs-secondary, #6c757d);
    }

    [data-bs-theme="dark"] .provider-name {
        color: var(--bs-secondary, #adb5bd);
    }

    .provider-status {
        font-weight: 500;
    }

    .total-duration {
        text-align: right;
        font-size: 0.8rem;
        color: var(--bs-secondary, #6c757d);
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--bs-border-color);
    }

    [data-bs-theme="dark"] .total-duration {
        color: var(--bs-secondary, #adb5bd);
    }

    .action-links {
        display: flex;
        gap: 1rem;
        padding-top: 1.5rem;
        margin-top: 1.5rem;
        border-top: 1px solid var(--bs-border-color);
    }

    .action-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--bs-link-color, #0d6efd);
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .action-link:hover {
        color: var(--bs-link-hover-color, #0a58ca);
        text-decoration: underline;
    }

    [data-bs-theme="dark"] .action-link {
        color: var(--bs-link-color, #6ea8fe);
    }

    [data-bs-theme="dark"] .action-link:hover {
        color: var(--bs-link-hover-color, #8bb9fe);
    }

    .btn-outline-primary {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        border-radius: 0.375rem;
    }
</style>