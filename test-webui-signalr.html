<!DOCTYPE html>
<html>
<head>
    <title>WebUI SignalR Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
</head>
<body>
    <h1>WebUI SignalR Connection Test</h1>
    <div id="status">Initializing...</div>
    <div id="details"></div>
    
    <script>
        // Get virtual key from Admin API first
        fetch('http://localhost:5002/api/virtualkeys', {
            headers: { 'X-API-Key': 'alpha' }
        })
        .then(res => res.json())
        .then(keys => {
            const webuiKey = keys.find(k => k.keyName.includes('WebUI'));
            if (!webuiKey) {
                document.getElementById('status').innerText = 'No WebUI key found';
                return;
            }
            
            // Create new key to get full value
            return fetch('http://localhost:5002/api/virtualkeys', {
                method: 'POST',
                headers: { 
                    'X-API-Key': 'alpha',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    keyName: 'SignalR Test Key',
                    isEnabled: true
                })
            });
        })
        .then(res => res.json())
        .then(data => {
            const virtualKey = data.virtualKey;
            document.getElementById('details').innerHTML = `<p>Using key: ${virtualKey.substring(0, 20)}...</p>`;
            
            // Try to connect to SignalR
            const connection = new signalR.HubConnectionBuilder()
                .withUrl('http://localhost:5000/hubs/notifications', {
                    accessTokenFactory: () => virtualKey,
                    withCredentials: true
                })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Debug)
                .build();
            
            connection.on("NavigationStateUpdated", (data) => {
                document.getElementById('details').innerHTML += '<p style="color: green;">✓ Received NavigationStateUpdated event!</p>';
                console.log('NavigationStateUpdated:', data);
            });
            
            connection.start()
                .then(() => {
                    document.getElementById('status').innerHTML = '<h2 style="color: green;">✅ CONNECTED!</h2>';
                    document.getElementById('details').innerHTML += `<p>Connection ID: ${connection.connectionId}</p>`;
                })
                .catch(err => {
                    document.getElementById('status').innerHTML = '<h2 style="color: red;">❌ CONNECTION FAILED</h2>';
                    document.getElementById('details').innerHTML += `<p style="color: red;">Error: ${err}</p>`;
                    console.error(err);
                });
        })
        .catch(err => {
            document.getElementById('status').innerText = 'Error: ' + err;
            console.error(err);
        });
    </script>
</body>
</html>