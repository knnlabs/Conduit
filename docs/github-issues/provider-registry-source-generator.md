# Create Source Generator for Automatic Provider Registration

## Overview
Replace the current reflection-based provider discovery in `ProviderMetadataRegistry` with a compile-time source generator to improve startup performance and enable build-time validation of provider metadata.

## Current Implementation
The `ProviderMetadataRegistry` currently discovers provider metadata implementations at runtime using reflection:

```csharp
var providerMetadataTypes = AppDomain.CurrentDomain.GetAssemblies()
    .Where(a => !a.IsDynamic && a.FullName != null && 
               (a.FullName.StartsWith("ConduitLLM") || a.FullName.StartsWith("Extensions")))
    .SelectMany(a => a.GetTypes())
    .Where(t => t.IsClass && !t.IsAbstract && 
               typeof(IProviderMetadata).IsAssignableFrom(t))
    .ToList();
```

## Proposed Solution
Create a Roslyn source generator that:

1. **Discovers all `IProviderMetadata` implementations at compile time**
2. **Generates a partial class for `ProviderMetadataRegistry`** with hardcoded registration
3. **Validates provider metadata at build time** to catch configuration errors early
4. **Generates compile-time constants** for provider capabilities

### Example Generated Code
```csharp
// <auto-generated />
namespace ConduitLLM.Core.Services
{
    public partial class ProviderMetadataRegistry
    {
        private void RegisterGeneratedProviders()
        {
            // Generated at compile time
            _providers.TryAdd(ProviderType.OpenAI, new Providers.Metadata.OpenAIProviderMetadata());
            _providers.TryAdd(ProviderType.Anthropic, new Providers.Metadata.AnthropicProviderMetadata());
            _providers.TryAdd(ProviderType.AzureOpenAI, new Providers.Metadata.AzureOpenAIProviderMetadata());
            // ... all other providers ...
        }
        
        // Generated capability constants for compile-time checks
        public static class ProviderCapabilities
        {
            public const bool OpenAI_SupportsStreaming = true;
            public const bool OpenAI_SupportsImageGeneration = true;
            // ... etc ...
        }
    }
}
```

## Benefits

### 1. **Performance Improvements**
- Eliminates reflection overhead at startup
- No assembly scanning required
- Faster application startup time
- Reduced memory allocation during initialization

### 2. **Build-Time Validation**
- Detect missing `ProviderType` enum values at compile time
- Validate that all providers have metadata implementations
- Ensure metadata classes have parameterless constructors
- Catch configuration errors before runtime

### 3. **Better Developer Experience**
- IntelliSense for provider capabilities
- Compile-time constants for feature flags
- Clear error messages during build if providers are misconfigured
- Source generator diagnostics in IDE

### 4. **Improved Maintainability**
- Generated code is debuggable
- Clear separation between generated and manual code
- Easier to understand provider registration flow
- Reduced "magic" in the codebase

## Implementation Steps

### 1. Create Source Generator Project
```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
    <LangVersion>latest</LangVersion>
  </PropertyGroup>
  
  <ItemGroup>
    <PackageReference Include="Microsoft.CodeAnalysis.CSharp" Version="4.8.0" />
    <PackageReference Include="Microsoft.CodeAnalysis.Analyzers" Version="3.3.4" />
  </ItemGroup>
</Project>
```

### 2. Implement Provider Discovery Generator
```csharp
[Generator]
public class ProviderMetadataGenerator : ISourceGenerator
{
    public void Initialize(GeneratorInitializationContext context)
    {
        context.RegisterForSyntaxNotifications(() => new ProviderMetadataSyntaxReceiver());
    }

    public void Execute(GeneratorExecutionContext context)
    {
        // Generate the registration code
    }
}
```

### 3. Update ProviderMetadataRegistry
- Make the class `partial`
- Replace reflection code with call to `RegisterGeneratedProviders()`
- Add fallback to reflection for development/testing scenarios

### 4. Add Build-Time Validation
- Validate all `ProviderType` enum values have corresponding metadata
- Check for duplicate provider registrations
- Ensure metadata classes are properly configured

## Testing Requirements

1. **Unit Tests**
   - Test the source generator with various provider configurations
   - Verify generated code compiles correctly
   - Test edge cases (missing providers, duplicates, etc.)

2. **Integration Tests**
   - Ensure generated registry works with existing code
   - Verify all providers are properly registered
   - Test that capabilities are correctly exposed

3. **Performance Tests**
   - Measure startup time improvement
   - Compare memory usage with reflection-based approach

## Acceptance Criteria

- [ ] Source generator project created and integrated into build
- [ ] All existing provider metadata classes are discovered at compile time
- [ ] Generated code successfully registers all providers
- [ ] Build-time validation catches missing providers
- [ ] Startup performance is measurably improved
- [ ] No regression in functionality
- [ ] Documentation updated with source generator information
- [ ] Unit tests for source generator logic
- [ ] Integration tests pass with generated code

## Technical Considerations

1. **Incremental Generation**: Use incremental generators for better IDE performance
2. **Multi-targeting**: Ensure generator works with all target frameworks
3. **Error Handling**: Graceful degradation if generation fails
4. **Debugging**: Generated code should be easily debuggable

## References
- [Source Generators Documentation](https://learn.microsoft.com/en-us/dotnet/csharp/roslyn-sdk/source-generators-overview)
- [Incremental Generators](https://github.com/dotnet/roslyn/blob/main/docs/features/incremental-generators.md)
- [Source Generator Samples](https://github.com/dotnet/roslyn-sdk/tree/main/samples/CSharp/SourceGenerators)

## Estimated Effort
- **Complexity**: Medium
- **Estimated Time**: 2-3 days
- **Skills Required**: C#, Roslyn, Source Generators

## Labels
- `enhancement`
- `performance`
- `build-tools`
- `provider-registry`

## Milestone
Provider Registry Improvements

## Related Issues
- Provider Registry Pattern Implementation (completed)
- Provider Type Migration (#627, #625, #624)